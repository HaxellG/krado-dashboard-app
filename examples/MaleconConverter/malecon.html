<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Krado</title>
  
  <!-- CSS externos -->
  <link rel="stylesheet" href="./libs/potree/potree.css">
  <link rel="stylesheet" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" href="./libs/jstree/themes/mixed/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Deep purple theme colors
            primary: '#8B5CF6',
            'primary-light': '#A78BFA',
            'primary-dark': '#7C3AED',
            'primary-glow': '#A78BFA',
            
            // Ultra dark backgrounds
            'bg-darkest': '#0A0A0F',
            'bg-dark': '#12121A',
            'bg-card': '#1A1A25',
            'bg-elevated': '#22223D',
            
            // Border and text colors
            'border-subtle': '#2A2A40',
            'text-muted': '#6B6B80',
            'text-secondary': '#9090A0'
          },
          animation: {
            'glow-pulse': 'glow-pulse 2s ease-in-out infinite',
            'fade-in': 'fade-in 0.5s ease-out',
            'slide-in': 'slide-in 0.3s ease-out'
          },
          boxShadow: {
            'glow': '0 0 20px rgba(139, 92, 246, 0.15)',
            'glow-lg': '0 0 40px rgba(139, 92, 246, 0.2)',
            'inner-glow': 'inset 0 0 20px rgba(139, 92, 246, 0.1)',
            'card': '0 2px 8px rgba(0, 0, 0, 0.4), 0 0 1px rgba(139, 92, 246, 0.2)'
          }
        }
      }
    };
    
    /* Close Modal with Animation */
    window.closeModalWithAnimation = (button) => {
      const modal = button.closest('.fixed');
      if (modal) {
        // Add closing animation class
        modal.classList.add('modal-closing');
        
        // Remove modal after animation completes
        setTimeout(() => {
          cleanupMiniViewer();
          modal.remove();
        }, 300); // Match animation duration
      }
    };
    
    /* Initialize Mini 3D Viewer */
    let originalViewerParent = null;
    let originalCameraPosition = null;
    let originalCameraTarget = null;
    
    const initializeMiniViewer = async (item) => {
      try {
        console.log('üéØ Setting up mini 3D viewer for event:', item.title);
        
        const container = document.getElementById('miniViewer3D');
        if (!container || !window.viewer) {
          console.error('‚ùå Mini viewer container or main viewer not found');
          return;
        }
        
        // Clear loading content
        container.innerHTML = '';
        
        // Store original viewer parent and camera state
        const potreeContainer = document.querySelector('.potree_container');
        if (potreeContainer) {
          originalViewerParent = potreeContainer.parentNode;
          
          // Store current camera state
          if (window.viewer.scene) {
            originalCameraPosition = window.viewer.scene.view.position.clone();
            originalCameraTarget = window.viewer.scene.view.getPivot();
          }
          
          // Move potree container to modal
          container.appendChild(potreeContainer);
          
          // Resize viewer to fit modal container
          setTimeout(() => {
            if (window.viewer && window.viewer.resize) {
              window.viewer.resize();
            }
          }, 100);
          
          // Convert GPS coordinates to 3D position
          const [x, y] = proj4(window.wgs84 || 'EPSG:4326', window.utm18 || 'EPSG:32618', [item.longitude, item.latitude]);
          const eventPosition = { x, y, z: item.altitude + 30 };
          
          console.log('üìç Event 3D position:', eventPosition);
          
          // Create sphere at event location
          const sphereGeometry = new THREE.SphereGeometry(5, 24, 24); // Reduced from 8 to 5
          const sphereMaterial = new THREE.MeshBasicMaterial({
            color: '#8B5CF6',
            transparent: true,
            opacity: 0.8
          });
          
          const modalEventSphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
          modalEventSphere.position.set(eventPosition.x, eventPosition.y, eventPosition.z);
          modalEventSphere.userData = { isModalSphere: true };
          
          // Make globally accessible
          window.modalEventSphere = modalEventSphere;
          
          // Add glow effect
          const glowGeometry = new THREE.SphereGeometry(8, 24, 24); // Reduced from 12 to 8
          const glowMaterial = new THREE.MeshBasicMaterial({
            color: '#A78BFA',
            transparent: true,
            opacity: 0.3
          });
          
          const modalGlowSphere = new THREE.Mesh(glowGeometry, glowMaterial);
          modalGlowSphere.position.set(eventPosition.x, eventPosition.y, eventPosition.z);
          modalGlowSphere.userData = { isModalSphere: true };
          
          // Make globally accessible
          window.modalGlowSphere = modalGlowSphere;
          
          // Add spheres to existing scene
          if (window.viewer.scene && window.viewer.scene.scene) {
            window.viewer.scene.scene.add(window.modalEventSphere);
            window.viewer.scene.scene.add(window.modalGlowSphere);
          }
          
          // Position camera to focus on the event location
          setTimeout(() => {
            const cameraDistance = 150;
            const cameraPosition = new THREE.Vector3(
              eventPosition.x + cameraDistance,
              eventPosition.y + cameraDistance,
              eventPosition.z + cameraDistance * 0.5
            );
            
            if (window.viewer.scene) {
              window.viewer.scene.view.position.copy(cameraPosition);
              window.viewer.scene.view.lookAt(new THREE.Vector3(eventPosition.x, eventPosition.y, eventPosition.z));
            }
          }, 200);
          
          console.log('‚úÖ Mini 3D viewer setup completed');
        }
        
        // Handle modal close to cleanup
        const modal = container.closest('.fixed');
        if (modal) {
          const originalRemove = modal.remove;
          modal.remove = function() {
            cleanupMiniViewer();
            originalRemove.call(this);
          };
          
          // Also handle close button - no longer needed since we have closeModalWithAnimation
        }
        
      } catch (error) {
        console.error('‚ùå Error setting up mini viewer:', error);
        
        // Show error message in container
        const container = document.getElementById('miniViewer3D');
        if (container) {
          container.innerHTML = `
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-center">
                <svg class="w-8 h-8 text-red-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="text-red-400 text-sm">Error al cargar el visor 3D</p>
              </div>
            </div>
          `;
        }
      }
    };
    
    /* Cleanup Mini Viewer */
    const cleanupMiniViewer = () => {
      try {
        console.log('üßπ Cleaning up mini 3D viewer...');
        
        // Remove modal spheres from scene
        if (window.modalEventSphere && window.viewer.scene && window.viewer.scene.scene) {
          window.viewer.scene.scene.remove(window.modalEventSphere);
          window.modalEventSphere.geometry.dispose();
          window.modalEventSphere.material.dispose();
          window.modalEventSphere = null;
        }
        
        if (window.modalGlowSphere && window.viewer.scene && window.viewer.scene.scene) {
          window.viewer.scene.scene.remove(window.modalGlowSphere);
          window.modalGlowSphere.geometry.dispose();
          window.modalGlowSphere.material.dispose();
          window.modalGlowSphere = null;
        }
        
        // Move potree container back to original location
        const potreeContainer = document.querySelector('.potree_container');
        if (potreeContainer && originalViewerParent) {
          originalViewerParent.appendChild(potreeContainer);
          
          // Restore original camera position
          setTimeout(() => {
            if (window.viewer && window.viewer.scene && originalCameraPosition) {
              window.viewer.scene.view.position.copy(originalCameraPosition);
              if (originalCameraTarget) {
                window.viewer.scene.view.lookAt(originalCameraTarget);
              }
            }
            
            // Resize viewer back to original size
            if (window.viewer && window.viewer.resize) {
              window.viewer.resize();
            }
          }, 100);
        }
        
        // Reset stored values
        originalViewerParent = null;
        originalCameraPosition = null;
        originalCameraTarget = null;
        
        console.log('‚úÖ Mini 3D viewer cleanup completed');
        
      } catch (error) {
        console.error('‚ùå Error during mini viewer cleanup:', error);
      }
    };
    
    /* Setup Analysis Form Handler */
    const setupAnalysisForm = () => {
      const form = document.getElementById('analysisForm');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const analyzeBtnText = document.getElementById('analyzeBtnText');
      const analyzeIcon = document.getElementById('analyzeIcon');
      
      if (!form) return;
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Get form values
        const deviceId = document.getElementById('deviceIdInput').value.trim();
        const startDateTime = document.getElementById('startDateTime').value;
        const endDateTime = document.getElementById('endDateTime').value;
        const limit = parseInt(document.getElementById('limitInput').value) || 10;
        
        // Validate inputs
        if (!deviceId) {
          alert('Por favor ingrese un ID de dispositivo v√°lido');
          return;
        }
        
        if (!startDateTime || !endDateTime) {
          alert('Por favor seleccione las fechas y horas de inicio y fin');
          return;
        }
        
        if (new Date(startDateTime) >= new Date(endDateTime)) {
          alert('La fecha de inicio debe ser anterior a la fecha de fin');
          return;
        }
        
        // Show loading state
        setLoadingState(true);
        
        try {
          await fetchAnalysisData(deviceId, startDateTime, endDateTime, limit);
        } catch (error) {
          console.error('Error in form submission:', error);
        } finally {
          // Hide loading state
          setLoadingState(false);
        }
      });
    };
    
    /* Set Loading State */
    const setLoadingState = (loading) => {
      const analyzeBtn = document.getElementById('analyzeBtn');
      const analyzeBtnText = document.getElementById('analyzeBtnText');
      const analyzeIcon = document.getElementById('analyzeIcon');
      
      if (!analyzeBtn) return;
      
      if (loading) {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('opacity-75', 'cursor-not-allowed');
        analyzeBtnText.textContent = 'Procesando...';
        
        // Replace icon with loading spinner
        analyzeIcon.innerHTML = `
          <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        `;
      } else {
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        analyzeBtnText.textContent = 'Ejecutar An√°lisis';
        
        // Restore original icon
        analyzeIcon.innerHTML = `
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        `;
      }
    };
    
    /* Convert datetime-local to Colombia timezone timestamp */
    const convertToColombiaTimestamp = (datetimeLocal) => {
      // Create a date object from the datetime-local input
      // datetime-local format: "2025-05-29T08:00"
      
      // Parse the datetime string manually to avoid timezone interpretation issues
      const [datePart, timePart] = datetimeLocal.split('T');
      const [year, month, day] = datePart.split('-').map(Number);
      const [hour, minute] = timePart.split(':').map(Number);
      
      // Create date in Colombia timezone (UTC-5)
      // We create a UTC date and then subtract 5 hours to get Colombia time
      const utcDate = new Date(Date.UTC(year, month - 1, day, hour, minute));
      
      // Colombia is UTC-5, so we add 5 hours to the UTC date to get the correct timestamp
      // This makes the API receive the time as if it were entered in Colombia timezone
      const colombiaTimestamp = Math.floor((utcDate.getTime() + (5 * 60 * 60 * 1000)) / 1000);      
      return colombiaTimestamp;
    };
    
    /* API call for analysis data */
    const fetchAnalysisData = async (deviceId, startDateTime, endDateTime, limit) => {
      try {
        // Convert datetime inputs to Colombia timezone timestamps
        const startTimestamp = convertToColombiaTimestamp(startDateTime);
        const endTimestamp = convertToColombiaTimestamp(endDateTime);
        
        // API call parameters
        const params = {
          deviceId: deviceId,
          startTimestamp: startTimestamp,
          endTimestamp: endTimestamp,
          limit: limit
        };
              
        // Update analysis status
        updateAnalysisStatus('Consultando datos...', 'text-blue-400');
        
        // Make the API call
        const response = await axios.get('https://iqhtm867sh.execute-api.us-east-1.amazonaws.com/default/kradoLocations', {
          params: params,
          timeout: 30000 // 30 second timeout
        });
        
        console.log('‚úÖ API Response received:', response.data);
        
        // Extract items from response
        const items = response.data.items || [];
        const count = response.data.count || 0;
                
        // Update analysis status
        updateAnalysisStatus(`${count} registros encontrados`, 'text-green-400');
        
        // Update analysis table with GPS data
        updateAnalysisTable(items);
        
        // Render 3D GPS visualization
        if (items.length > 0) {
          render3DGPSVisualization(items, deviceId);
          // Also render 2D GPS track on analysis minimap
          render2DGPSVisualization(items, deviceId);
        }
        
      } catch (error) {
        console.error('‚ùå Error fetching analysis data:', error);
        console.error('üìã Error details:', {
          message: error.message,
          response: error.response?.data,
          status: error.response?.status
        });
        
        // Update analysis status with error
        updateAnalysisStatus('Error en la consulta', 'text-red-400');
        
        // Clear table and visualization on error
        updateAnalysisTable([]);
        clearAnalysisVisualization();
        clear2DGPSVisualization();
      }
    };
    
    /* Update analysis status */
    const updateAnalysisStatus = (message, colorClass) => {
      const statusEl = document.querySelector('#map_container_analysis').parentElement.querySelector('.text-primary-light');
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = `text-sm font-medium ${colorClass}`;
      }
    };
    
    /* Update analysis table with GPS data */
    const updateAnalysisTable = (items) => {      
      const tbody = document.querySelector('#analysisTable tbody');
      if (!tbody) return;
      
      // Clear existing rows
      tbody.innerHTML = '';
      
      if (!items || items.length === 0) {
        // Show "No data" message
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="4" class="text-center py-8 text-text-muted">
            No se encontraron datos GPS para los par√°metros especificados
          </td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      // Add rows for GPS data
      items.forEach((item, index) => {
        const row = document.createElement('tr');
        
        // Format timestamp to readable date
        const date = new Date(item.timestamp * 1000);
        const timeString = date.toLocaleString('es-CO', {
          timeZone: 'America/Bogota',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        row.innerHTML = `
          <td>${String(index + 1).padStart(3, '0')}</td>
          <td>GPS ${item.deviceId.slice(-4)}</td>
          <td>
            <div class="text-xs space-y-1">
              <div>üìç ${item.latitude.toFixed(6)}, ${item.longitude.toFixed(6)}</div>
              <div>‚õ∞Ô∏è ${item.altitude.toFixed(2)}m</div>
              <div>üïí ${timeString}</div>
            </div>
          </td>
          <td><span class="text-green-400">‚úÖ Procesado</span></td>
        `;
        tbody.appendChild(row);
      });
      
    };
    
    /* 3D GPS Visualization */
    let analysisVisualizationGroup = null; // Store reference to analysis visualization
    
    const render3DGPSVisualization = (items, deviceId) => {
      console.log(`üéØ Rendering 3D GPS visualization for ${items.length} coordinates`);
      
      if (!viewer || !viewer.scene || !viewer.scene.scene) {
        console.warn('‚ö†Ô∏è 3D viewer not ready for GPS visualization');
        return;
      }
      
      // Clear previous analysis visualization
      clearAnalysisVisualization();
      
      // Create new group for analysis visualization
      analysisVisualizationGroup = new THREE.Group();
      analysisVisualizationGroup.name = 'AnalysisVisualization';
      
      // Ensure projection constants are available
      const wgs84Proj = window.wgs84 || 'EPSG:4326';
      const utm18Proj = window.utm18 || 'EPSG:32618';
            
      // Convert GPS coordinates to 3D positions
      const positions3D = items.map(item => {
        try {
          const [x, y] = proj4(wgs84Proj, utm18Proj, [item.longitude, item.latitude]);
          return {
            x: x,
            y: y,
            z: item.altitude + 50, // Add height offset for visibility
            ...item
          };
        } catch (error) {
          console.error('‚ùå Error converting coordinates for item:', item, error);
          return null;
        }
      }).filter(pos => pos !== null); // Remove failed conversions
            
      if (positions3D.length === 0) {
        console.error('‚ùå No valid 3D positions generated from GPS data');
        return;
      }
      
      // Create spheres for each GPS coordinate
      createGPSSpheres(positions3D, deviceId);
      
      // Create path connecting the spheres
      createGPSPath(positions3D, deviceId);
      
      // Add visualization group to scene
      viewer.scene.scene.add(analysisVisualizationGroup);
      
      // Center camera on the GPS data
      centerCameraOnGPSData(positions3D);      
    };
    
    const createGPSSpheres = (positions, deviceId) => {
      
      // Get device color or create new one
      let color = window.deviceColorMap[deviceId];
      if (!color) {
        const colorIndex = Object.keys(window.deviceColorMap).length % window.deviceColors.length;
        color = window.deviceColors[colorIndex];
        window.deviceColorMap[deviceId] = color;
      }
      
      // Create sphere geometry (small spheres for GPS points)
      const sphereGeometry = new THREE.SphereGeometry(2, 16, 16);
      
      positions.forEach((pos, index) => {
        // Create material with device color
        const sphereMaterial = new THREE.MeshBasicMaterial({
          color: color.base,
          transparent: true,
          opacity: 0.8
        });
        
        // Create sphere mesh
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        sphere.position.set(pos.x, pos.y, pos.z);
        
        // Add metadata
        sphere.userData = {
          type: 'gps_point',
          deviceId: deviceId,
          index: index,
          gpsData: pos
        };
        
        analysisVisualizationGroup.add(sphere);
      });      
    };
    
    const createGPSPath = (positions, deviceId) => {
      
      if (positions.length < 2) {
        console.log('‚ö†Ô∏è Need at least 2 points to create path');
        return;
      }
      
      // Get device color
      const color = window.deviceColorMap[deviceId];
      if (!color) {
        console.warn('‚ö†Ô∏è No color found for device:', deviceId);
        return;
      }
      
      // Create path geometry
      const pathPoints = positions.map(pos => new THREE.Vector3(pos.x, pos.y, pos.z));
      const pathGeometry = new THREE.BufferGeometry().setFromPoints(pathPoints);
      
      // Create path material
      const pathMaterial = new THREE.LineBasicMaterial({
        color: color.light,
        linewidth: 3,
        transparent: true,
        opacity: 0.7
      });
      
      // Create line
      const pathLine = new THREE.Line(pathGeometry, pathMaterial);
      pathLine.userData = {
        type: 'gps_path',
        deviceId: deviceId
      };
      
      analysisVisualizationGroup.add(pathLine);
      
      console.log('‚úÖ GPS path created successfully');
    };
    
    const centerCameraOnGPSData = (positions) => {
      if (positions.length === 0) return;
      
      // Calculate bounding box
      const bounds = {
        minX: Math.min(...positions.map(p => p.x)),
        maxX: Math.max(...positions.map(p => p.x)),
        minY: Math.min(...positions.map(p => p.y)),
        maxY: Math.max(...positions.map(p => p.y)),
        minZ: Math.min(...positions.map(p => p.z)),
        maxZ: Math.max(...positions.map(p => p.z))
      };
      
      // Calculate center point
      const center = new THREE.Vector3(
        (bounds.minX + bounds.maxX) / 2,
        (bounds.minY + bounds.maxY) / 2,
        (bounds.minZ + bounds.maxZ) / 2
      );
      
      // Calculate appropriate distance
      const size = Math.max(
        bounds.maxX - bounds.minX,
        bounds.maxY - bounds.minY,
        bounds.maxZ - bounds.minZ
      );
      
      const distance = size * 2; // Adjust multiplier as needed
      
      // Position camera
      const camera = viewer.scene.getActiveCamera();
      const offset = new THREE.Vector3(distance, distance, distance * 0.5);
      
      viewer.scene.view.position.copy(center.clone().add(offset));
      viewer.scene.view.lookAt(center);      
    };
    
    const clearAnalysisVisualization = () => {
      if (analysisVisualizationGroup && viewer.scene && viewer.scene.scene) {
        viewer.scene.scene.remove(analysisVisualizationGroup);
        
        // Dispose of geometries and materials to free memory
        analysisVisualizationGroup.traverse((child) => {
          if (child.geometry) child.geometry.dispose();
          if (child.material) {
            if (Array.isArray(child.material)) {
              child.material.forEach(material => material.dispose());
            } else {
              child.material.dispose();
            }
          }
        });
        
        analysisVisualizationGroup = null;
      }
    };
    
    /* 2D GPS Visualization for Analysis Minimap */
    let analysisGPSMarkers = []; // Store GPS markers
    let analysisGPSPath = null;  // Store GPS path
    
    const render2DGPSVisualization = (items, deviceId) => {      
      if (!window.mapAnalysis) {
        console.warn('‚ö†Ô∏è Analysis map not ready for GPS visualization');
        return;
      }
      
      // Clear previous GPS visualization
      clear2DGPSVisualization();
      
      if (items.length === 0) {
        console.log('‚ö†Ô∏è No GPS data to visualize on 2D map');
        return;
      }
      
      // Get device color
      let color = window.deviceColorMap[deviceId];
      if (!color) {
        const colorIndex = Object.keys(window.deviceColorMap).length % window.deviceColors.length;
        color = window.deviceColors[colorIndex];
        window.deviceColorMap[deviceId] = color;
      }
      
      // Create GPS markers
      create2DGPSMarkers(items, deviceId, color);
      
      // Create GPS path
      create2DGPSPath(items, deviceId, color);
      
      // Center map on GPS data
      center2DMapOnGPSData(items);
      
      console.log('‚úÖ 2D GPS track rendered successfully on analysis minimap');
    };
    
    const create2DGPSMarkers = (items, deviceId, color) => {      
      items.forEach((item, index) => {
        // Create circle marker for each GPS point
        const marker = L.circleMarker([item.latitude, item.longitude], {
          radius: 4,
          color: color.light,
          fillColor: color.base,
          fillOpacity: 0.8,
          weight: 2,
          opacity: 0.9
        });
        
        // Add popup with GPS info
        const date = new Date(item.timestamp * 1000);
        const timeString = date.toLocaleString('es-CO', {
          timeZone: 'America/Bogota',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        marker.bindPopup(`
          <div class="text-xs">
            <div class="font-bold mb-1" style="color: ${color.light}">
              GPS ${deviceId.slice(-4)} - Punto ${index + 1}
            </div>
            <div class="space-y-1">
              <div>üìç ${item.latitude.toFixed(6)}, ${item.longitude.toFixed(6)}</div>
              <div>‚õ∞Ô∏è ${item.altitude.toFixed(2)}m</div>
              <div>üïí ${timeString}</div>
            </div>
          </div>
        `, {
          className: 'tooltip-glow'
        });
        
        // Add to map and store reference
        marker.addTo(window.mapAnalysis);
        analysisGPSMarkers.push(marker);
      });      
    };
    
    const create2DGPSPath = (items, deviceId, color) => {      
      if (items.length < 2) {
        console.log('‚ö†Ô∏è Need at least 2 points to create path on 2D map');
        return;
      }
      
      // Create array of lat/lng points for the path
      const pathPoints = items.map(item => [item.latitude, item.longitude]);
      
      // Create polyline
      analysisGPSPath = L.polyline(pathPoints, {
        color: color.light,
        weight: 3,
        opacity: 0.8,
        smoothFactor: 1
      });
      
      // Add popup to path
      analysisGPSPath.bindPopup(`
        <div class="text-xs">
          <div class="font-bold mb-1" style="color: ${color.light}">
            Ruta GPS ${deviceId.slice(-4)}
          </div>
          <div class="space-y-1">
            <div>üìä ${items.length} puntos GPS</div>
            <div>üìè Distancia total calculada</div>
            <div>üïí Desde ${new Date(items[0].timestamp * 1000).toLocaleTimeString('es-CO', {timeZone: 'America/Bogota'})}</div>
            <div>üïí Hasta ${new Date(items[items.length-1].timestamp * 1000).toLocaleTimeString('es-CO', {timeZone: 'America/Bogota'})}</div>
          </div>
        </div>
      `, {
        className: 'tooltip-glow'
      });
      
      // Add to map
      analysisGPSPath.addTo(window.mapAnalysis);
      
      console.log('‚úÖ GPS path created successfully on 2D map');
    };
    
    const center2DMapOnGPSData = (items) => {
      if (items.length === 0) return;      
      if (items.length === 1) {
        // Single point - center on it
        window.mapAnalysis.setView([items[0].latitude, items[0].longitude], 18, {
          animate: true,
          duration: 1
        });
      } else {
        // Multiple points - fit bounds
        const bounds = L.latLngBounds();
        items.forEach(item => {
          bounds.extend([item.latitude, item.longitude]);
        });
        
        window.mapAnalysis.fitBounds(bounds, {
          padding: [20, 20],
          animate: true,
          duration: 1
        });
      }
      
      console.log('‚úÖ 2D analysis map centered on GPS data');
    };
    
    const clear2DGPSVisualization = () => {      
      // Remove GPS markers
      analysisGPSMarkers.forEach(marker => {
        if (window.mapAnalysis) {
          window.mapAnalysis.removeLayer(marker);
        }
      });
      analysisGPSMarkers = [];
      
      // Remove GPS path
      if (analysisGPSPath && window.mapAnalysis) {
        window.mapAnalysis.removeLayer(analysisGPSPath);
        analysisGPSPath = null;
      }      
    };
    
    /* Events View Initialization */
    const initializeEventsView = () => {
      
      // Load events data from API
      loadEventsData();
      
      // Add click handler to refresh button
      const refreshBtn = document.querySelector('#viewEvents button');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          console.log('üîÑ Refreshing events gallery...');
          refreshEventsGallery();
        });
      }      
    };
    
    /* Load Events Data from API */
    const loadEventsData = async () => {
      try {        
        // Show loading state
        showEventsLoading(true);
        
        // Make API request
        const response = await axios.get('https://iqhtm867sh.execute-api.us-east-1.amazonaws.com/default/kradoResources', {
          params: {
            deviceId: '3014344057'
          },
          timeout: 10000 // 10 second timeout
        });
        
        console.log('‚úÖ Events data received:', response.data);
        
        // Extract items from response
        const items = response.data.items || [];
        const count = response.data.count || 0;
                
        // Render events cards
        renderEventsCards(items);
        
        // Update events count
        updateEventsCount(count);
        
      } catch (error) {
        console.error('‚ùå Error loading events data:', error);
        console.error('Error details:', {
          message: error.message,
          response: error.response?.data,
          status: error.response?.status
        });
        
        // Show error message
        showEventsError();
        
      } finally {
        // Hide loading state
        showEventsLoading(false);
      }
    };
    
    // Make loadEventsData globally accessible for error retry
    window.loadEventsData = loadEventsData;
    
    /* Render Events Cards */
    const renderEventsCards = (items) => {
      console.log('Items received from API:', items);
      
      const gallery = document.getElementById('eventsGallery');
      if (!gallery) return;
      
      // Clear existing cards
      gallery.innerHTML = '';
      
      if (!items || items.length === 0) {
        // Show empty state
        gallery.innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center py-12">
            <svg class="w-16 h-16 text-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <h3 class="text-lg font-semibold text-white mb-2">No hay eventos disponibles</h3>
            <p class="text-text-muted text-center">Los eventos aparecer√°n aqu√≠ cuando est√©n disponibles</p>
          </div>
        `;
        return;
      }
      
      // Create cards for each item
      items.forEach((item, index) => {        
        try {
          const card = createEventCard(item, index);
          gallery.appendChild(card);
        } catch (error) {
          console.error(`‚ùå Error creating card ${index + 1}:`, error);
        }
      });      
    };
    
    /* Create Event Card */
    const createEventCard = (item, index) => {
      
      // Calculate relative time
      const timeAgo = getRelativeTime(item.timestamp);
      
      // Get status badge from API tag field
      const statusBadge = getTagStatus(item);
      
      // Create card element
      const card = document.createElement('div');
      card.className = 'event-card glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in hover:scale-105 transition-all duration-300 cursor-pointer';
      card.style.animationDelay = `${Math.min(index * 0.1, 0.8)}s`;
      
      card.innerHTML = `
        <div class="aspect-square relative overflow-hidden">
          <img src="${item.resourceUrl}" 
               alt="${item.title || 'Evento reportado'}" 
               class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
               loading="lazy"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjMUExQTI1Ii8+CjxwYXRoIGQ9Ik0yMDAgMTAwVjMwME0xMDAgMjAwSDMwMCIgc3Ryb2tlPSIjNkI2QjgwIiBzdHJva2Utd2lkdGg9IjIiLz4KPHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeD0iMTgwIiB5PSIxODAiPgo8cGF0aCBkPSJNNCAxNmw0LjU4Ni00LjU4NmEyIDIgMCAwMTIuODI4IDBMMTYgMTZtLTItMmwxLjU4Ni0xLjU4NmEyIDIgMCAwMTIuODI4IDBMMjAgMTRtLTYtNmguMDFNNiAyMGgxMmEyIDIgMCAwMDItMlY2YTIgMiAwIDAwLTItMkg2YTIgMiAwIDAwLTIgMnYxMmEyIDIgMCAwMDIgMnoiIHN0cm9rZT0iIzZCNkI4MCIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo8L3N2Zz4K';">
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
          <div class="absolute top-4 right-4">
            <div class="px-2 py-1 ${statusBadge.bgClass} backdrop-blur-sm rounded-lg border ${statusBadge.borderClass}">
              <span class="text-xs ${statusBadge.textClass} font-medium">${statusBadge.text}</span>
            </div>
          </div>
        </div>
        <div class="p-4">
          <h3 class="text-lg font-semibold text-white mb-2">${item.title || 'Evento reportado'}</h3>
          <p class="text-text-muted text-sm leading-relaxed">${item.description || 'Sin descripci√≥n disponible'}</p>
          <div class="flex items-center justify-between mt-4">
            <span class="text-xs text-text-secondary">${timeAgo}</span>
            <div class="text-xs text-primary-light font-mono">Autor: ${item.deviceId}</div>
            <button class="text-primary-light hover:text-primary transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
              </svg>
            </button>
          </div>
        </div>
      `;
      
      // Add click handler for modal
      card.addEventListener('click', () => {
        openEventModal(item, index);
      });
      
      return card;
    };
    
    /* Get Relative Time */
    const getRelativeTime = (timestamp) => {
      const now = Math.floor(Date.now() / 1000);
      const diff = now - timestamp;
      
      if (diff < 60) return 'Hace menos de 1 minuto';
      if (diff < 3600) return `Hace ${Math.floor(diff / 60)} minutos`;
      if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} horas`;
      if (diff < 604800) return `Hace ${Math.floor(diff / 86400)} d√≠as`;
      if (diff < 2592000) return `Hace ${Math.floor(diff / 604800)} semanas`;
      return `Hace ${Math.floor(diff / 2592000)} meses`;
    };
    
    /* Get Tag Status from API */
    const getTagStatus = (item) => {
      const tag = item.tag || 'Nuevo'; // Default to 'Nuevo' if no tag field
      
      // Debug logging      
      switch (tag) {
        case 'Urgente':
          return {
            text: 'Urgente',
            bgClass: 'bg-red-500/20',
            borderClass: 'border-red-500/30',
            textClass: 'text-red-400'
          };
        case 'Precauci√≥n':
          return {
            text: 'Precauci√≥n',
            bgClass: 'bg-yellow-500/20',
            borderClass: 'border-yellow-500/30',
            textClass: 'text-yellow-400'
          };
        case 'Positivo':
          return {
            text: 'Positivo',
            bgClass: 'bg-green-500/20',
            borderClass: 'border-green-500/30',
            textClass: 'text-green-400'
          };
        case 'Novedad':
        default:
          return {
            text: 'Novedad',
            bgClass: 'bg-primary/20',
            borderClass: 'border-primary/30',
            textClass: 'text-primary-light'
          };
      }
    };
    
    /* Show Events Loading */
    const showEventsLoading = (loading) => {
      const gallery = document.getElementById('eventsGallery');
      if (!gallery) return;
      
      if (loading) {
        gallery.innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center py-12">
            <svg class="w-8 h-8 text-primary animate-spin mb-4" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-text-muted">Cargando eventos...</p>
          </div>
        `;
      }
    };
    
    /* Show Events Error */
    const showEventsError = () => {
      const gallery = document.getElementById('eventsGallery');
      if (!gallery) return;
      
      gallery.innerHTML = `
        <div class="col-span-full flex flex-col items-center justify-center py-12">
          <svg class="w-16 h-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <h3 class="text-lg font-semibold text-white mb-2">Error al cargar eventos</h3>
          <p class="text-text-muted text-center mb-4">Ocurri√≥ un error al cargar los eventos. Por favor intente nuevamente.</p>
          <button onclick="loadEventsData()" class="px-4 py-2 btn-primary rounded-lg text-sm">
            Reintentar
          </button>
        </div>
      `;
    };
    
    /* Update Events Count */
    const updateEventsCount = (count) => {
      const eventsCountEl = document.getElementById('eventsCount');
      if (eventsCountEl) {
        eventsCountEl.textContent = `${count} eventos`;
      }
    };
    
    const openEventModal = (item, index) => {
      // Format timestamp to readable date
      const date = new Date(item.timestamp * 1000);
      const formattedDate = date.toLocaleString('es-CO', {
        timeZone: 'America/Bogota',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // Create modal overlay
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in';
      modal.style.animation = 'fade-in 0.3s ease-out';
      
      modal.innerHTML = `
        <div class="glass-card rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto shadow-glow-lg border-2 border-primary/20 modal-content">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
            
            <!-- Left Panel - Image and Basic Info -->
            <div class="relative">
              <img src="${item.resourceUrl}" alt="${item.title || 'Evento reportado'}" class="w-full h-64 lg:h-80 object-cover rounded-t-2xl lg:rounded-tr-none lg:rounded-l-2xl">
              
              <!-- Image Info Overlay - Positioned at bottom edge -->
              <div class="absolute bottom-0 left-0 right-0">
                <div class="bg-gradient-to-r from-bg-dark/90 to-primary/20 backdrop-blur-sm rounded-b-2xl lg:rounded-bl-2xl lg:rounded-br-none p-4 border-t border-primary/30 shadow-glow">
                  <h2 class="text-2xl font-bold bg-gradient-to-r from-white to-primary-light bg-clip-text text-transparent mb-2">${item.title || 'Evento reportado'}</h2>
                  <p class="text-white/90 text-sm leading-relaxed mb-3">${item.description || 'Sin descripci√≥n disponible'}</p>
                  <div class="flex items-center gap-2 text-xs">
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-primary/20 rounded-full border border-primary/30">
                      <svg class="w-3 h-3 text-primary-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                      <span class="text-primary-light font-medium">Autor: ${item.deviceId}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Right Panel - 3D Viewer and Details -->
            <div class="p-6 flex flex-col bg-gradient-to-br from-bg-card/50 to-primary/5">
              
              <!-- 3D Mini Viewer -->
              <div class="mb-6">
                <h3 class="text-lg font-semibold bg-gradient-to-r from-white to-primary-light bg-clip-text text-transparent mb-3 flex items-center">
                  <div class="w-6 h-6 mr-3 rounded-full bg-gradient-to-r from-primary to-primary-light flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                  </div>
                  Ubicaci√≥n en el modelo 3D
                </h3>
                <div id="miniViewer3D" class="w-full h-72 bg-gradient-to-br from-bg-darkest to-bg-dark rounded-xl border-2 border-primary/20 shadow-inner-glow relative overflow-hidden">
                  <div class="absolute inset-0 flex items-center justify-center">
                    <div class="text-center">
                      <svg class="w-8 h-8 text-primary animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <p class="text-text-muted text-sm">Cargando visor 3D...</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Event Details -->
              <div class="space-y-4 flex-1">
                <h3 class="text-lg font-semibold bg-gradient-to-r from-white to-primary-light bg-clip-text text-transparent flex items-center">
                  <div class="w-6 h-6 mr-3 rounded-full bg-gradient-to-r from-primary to-primary-light flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                  Detalles del evento
                </h3>
                
                <div class="grid grid-cols-1 gap-3 text-sm bg-gradient-to-br from-bg-elevated/30 to-primary/5 rounded-xl p-4 border border-primary/10">
                  
                  <!-- Date and Time -->
                  <div class="flex items-center justify-between py-3 border-b border-primary/10">
                    <span class="text-text-muted flex items-center">
                      <div class="w-8 h-8 mr-3 rounded-full bg-primary/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-primary-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                      </div>
                      Fecha y hora
                    </span>
                    <span class="text-white font-mono text-sm">${formattedDate}</span>
                  </div>
                  
                  <!-- Device ID -->
                  <div class="flex items-center justify-between py-3 border-b border-primary/10">
                    <span class="text-text-muted flex items-center">
                      <div class="w-8 h-8 mr-3 rounded-full bg-primary/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-primary-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                      </div>
                      Dispositivo
                    </span>
                    <span class="text-primary-light font-mono font-semibold">${item.deviceId}</span>
                  </div>
                  
                  <!-- GPS Coordinates -->
                  <div class="flex items-center justify-between py-3 border-b border-primary/10">
                    <span class="text-text-muted flex items-center">
                      <div class="w-8 h-8 mr-3 rounded-full bg-primary/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-primary-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                      </div>
                      Coordenadas GPS
                    </span>
                    <span class="text-white font-mono text-right text-sm">
                      <div class="text-primary-light">${item.latitude.toFixed(6)}¬∞</div>
                      <div class="text-primary-light">${item.longitude.toFixed(6)}¬∞</div>
                    </span>
                  </div>
                  
                  <!-- Altitude -->
                  <div class="flex items-center justify-between py-3">
                    <span class="text-text-muted flex items-center">
                      <div class="w-8 h-8 mr-3 rounded-full bg-primary/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-primary-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                        </svg>
                      </div>
                      Altitud
                    </span>
                    <span class="text-white font-mono font-semibold">${item.altitude.toFixed(2)} m</span>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Close Button (Outside Modal) -->
        <button class="absolute top-4 right-4 w-12 h-12 bg-gradient-to-r from-bg-dark to-primary/30 hover:from-primary/20 hover:to-primary/40 backdrop-blur-sm rounded-full flex items-center justify-center text-white transition-all duration-300 hover:scale-110 shadow-glow border-2 border-primary/40 close-btn" onclick="closeModalWithAnimation(this)">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;
      
      // Add click outside to close with animation
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          // Add closing animation class
          modal.classList.add('modal-closing');
          
          // Remove modal after animation completes
          setTimeout(() => {
            cleanupMiniViewer();
            modal.remove();
          }, 300); // Match animation duration
        }
      });
      
      document.body.appendChild(modal);
      
      // Add ESC key support for smooth closing
      const handleEscKey = (e) => {
        if (e.key === 'Escape') {
          modal.classList.add('modal-closing');
          setTimeout(() => {
            cleanupMiniViewer();
            modal.remove();
            document.removeEventListener('keydown', handleEscKey);
          }, 300);
        }
      };
      document.addEventListener('keydown', handleEscKey);
      
      // Initialize mini 3D viewer after modal is added to DOM
      setTimeout(() => {
        initializeMiniViewer(item);
      }, 100);
    };
    
    const refreshEventsGallery = async () => {
      const refreshBtn = document.querySelector('#viewEvents button');
      const originalContent = refreshBtn.innerHTML;
      
      // Show loading state
      refreshBtn.innerHTML = `
        <svg class="w-4 h-4 inline mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Actualizando...
      `;
      refreshBtn.disabled = true;
      
      try {
        // Reload events data
        await loadEventsData();        
      } catch (error) {
        console.error('‚ùå Error refreshing events:', error);
      } finally {
        // Restore button state
        refreshBtn.innerHTML = originalContent;
        refreshBtn.disabled = false;
      }
    };
  </script>
  
  <style>
    /* Base styles */
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #0A0A0F;
      color: #E0E0EF;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    
    /* Glow animations */
    @keyframes glow-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }
    
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slide-in {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    /* Sidebar icon styles */
    .sidebar-icon {
      position: relative;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 0.5rem;
    }
    
    .sidebar-icon:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    
    .sidebar-icon.active {
      background: rgba(139, 92, 246, 0.15);
    }
    
    .sidebar-icon.active::before {
      content: '';
      position: absolute;
      left: -12px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 20px;
      background: linear-gradient(to bottom, transparent, #8B5CF6, transparent);
      border-radius: 2px;
    }
    
    .sidebar-icon svg {
      width: 20px;
      height: 20px;
      color: #6B6B80;
      transition: color 0.3s ease;
    }
    
    .sidebar-icon:hover svg,
    .sidebar-icon.active svg {
      color: #A78BFA;
      filter: drop-shadow(0 0 8px rgba(167, 139, 250, 0.5));
    }
    
    /* Card styles */l
    .glass-card {
      background: linear-gradient(135deg, #1A1A25 0%, #12121A 100%);
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .glass-card:hover {
      border-color: rgba(139, 92, 246, 0.2);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 30px rgba(139, 92, 246, 0.1);
    }
    
    /* Button styles */
    .btn-primary {
      background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%);
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .btn-secondary {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.3);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
    }
    
    /* Input styles */
    .input-dark {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(139, 92, 246, 0.1);
      transition: all 0.3s ease;
    }
    
    .input-dark:focus {
      outline: none;
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    /* Search bar styles */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .search-input {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 0.5rem 0 0 0.5rem;
      padding: 0.5rem 1rem;
      color: #E0E0EF;
      font-size: 0.875rem;
      width: 200px;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .search-input::placeholder {
      color: #6B6B80;
    }
    
    .search-btn {
      background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-left: none;
      border-radius: 0 0.5rem 0.5rem 0;
      padding: 0.5rem 0.75rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-btn:hover {
      background: linear-gradient(135deg, #6D28D9 0%, #7C3AED 100%);
      box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
    }
    
    .search-btn svg {
      width: 16px;
      height: 16px;
    }
    
    /* Stat card styles */
    .stat-value {
      background: linear-gradient(135deg, #A78BFA 0%, #8B5CF6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.3));
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.5);
    }
    
    /* Tooltip styles */
    .tooltip-glow {
      background: rgba(26, 26, 37, 0.95);
      border: 1px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(139, 92, 246, 0.2);
      backdrop-filter: blur(10px);
    }
    
    /* Device legend */
    .device-legend {
      background: rgba(26, 26, 37, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.1);
    }
    
    .device-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      filter: drop-shadow(0 0 4px currentColor);
    }
    
    /* Device list item styles */
    .device-item {
      background: rgba(139, 92, 246, 0.05);
      border: 1px solid rgba(139, 92, 246, 0.1);
      border-radius: 0.5rem;
      padding: 0.75rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .device-item:hover {
      background: rgba(139, 92, 246, 0.1);
      border-color: rgba(139, 92, 246, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .device-item.active {
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.3);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
    }
    
    .device-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10B981;
      animation: pulse 2s infinite;
    }
    
    .device-status.offline {
      background: #6B7280;
      animation: none;
    }

    /* Table styles for analysis view */
    .analysis-table {
      background: rgba(26, 26, 37, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.1);
      border-radius: 0.75rem;
      overflow: hidden;
    }
    
    .analysis-table th {
      background: rgba(139, 92, 246, 0.1);
      border-bottom: 1px solid rgba(139, 92, 246, 0.2);
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      color: #A78BFA;
      font-size: 0.875rem;
    }
    
    .analysis-table td {
      padding: 0.75rem;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
      color: #E0E0EF;
      font-size: 0.875rem;
    }
    
    .analysis-table tr:last-child td {
      border-bottom: none;
    }
    
    .analysis-table tr:hover {
      background: rgba(139, 92, 246, 0.05);
    }

    /* Loading spinner animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }

    /* Event gallery styles */
    .event-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: center;
    }
    
    .event-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.6),
        0 0 40px rgba(139, 92, 246, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .event-card:hover .glass-card {
      border-color: rgba(139, 92, 246, 0.3);
    }
    
    .event-card img {
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .event-card:hover img {
      transform: scale(1.1);
    }
    
    /* Status badges */
    .event-status-badge {
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* Gallery responsive grid */
    @media (max-width: 768px) {
      #eventsGallery {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }
    
    @media (min-width: 769px) and (max-width: 1024px) {
      #eventsGallery {
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
      }
    }
    
    @media (min-width: 1025px) and (max-width: 1280px) {
      #eventsGallery {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* Image loading states */
    .event-card img {
      background: linear-gradient(45deg, #1A1A25, #12121A);
    }
    
    .event-card img:not([src]) {
      background: linear-gradient(45deg, #1A1A25 25%, #12121A 25%, #12121A 50%, #1A1A25 50%, #1A1A25 75%, #12121A 75%);
      background-size: 20px 20px;
      animation: loading-shimmer 2s linear infinite;
    }
    
    @keyframes loading-shimmer {
      0% { background-position: 0 0; }
      100% { background-position: 40px 40px; }
    }
    
    /* Modal animations */
    @keyframes modal-fade-out {
      from { 
        opacity: 1; 
        backdrop-filter: blur(10px);
      }
      to { 
        opacity: 0; 
        backdrop-filter: blur(0px);
      }
    }
    
    @keyframes modal-scale-out {
      from { 
        transform: scale(1) translateY(0);
        opacity: 1;
      }
      to { 
        transform: scale(0.85) translateY(20px);
        opacity: 0;
      }
    }
    
    @keyframes close-btn-pulse {
      from { 
        transform: scale(1.1) rotate(0deg);
      }
      to { 
        transform: scale(1.3) rotate(90deg);
      }
    }
    
    .modal-closing {
      animation: modal-fade-out 0.3s ease-out forwards;
    }
    
    .modal-closing .modal-content {
      animation: modal-scale-out 0.3s ease-out forwards;
    }
    
    .modal-closing .close-btn {
      animation: close-btn-pulse 0.3s ease-out forwards;
    }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden">
  <!-- Main Layout -->
  <div class="flex h-full bg-bg-darkest">
    
    <!-- Icon Sidebar (Left) -->
    <aside class="w-16 bg-bg-dark border-r border-border-subtle flex flex-col items-center py-4">
      <!-- Logo -->
      <div class="mb-8">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center shadow-glow">
          <span class="text-white font-bold text-lg">K</span>
        </div>
      </div>
      
      <!-- Navigation Icons -->
      <nav class="flex-1 flex flex-col gap-4">
        <div class="sidebar-icon active" data-view="3d" title="Vista 3D">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"/>
          </svg>
        </div>
        
        <div class="sidebar-icon" data-view="2d" title="Mapa 2D">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
          </svg>
        </div>
        
        <div class="sidebar-icon" data-view="analysis" title="An√°lisis">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        
        <div class="sidebar-icon" data-view="events" title="Eventos Reportados">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
        </div>
      </nav>
      
      <!-- Settings -->
      <div class="sidebar-icon mt-auto" title="Configuraci√≥n">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 bg-bg-darkest p-6 overflow-hidden">
      <div class="h-full flex flex-col gap-6">
        
        <!-- Header -->
        <header class="flex items-center justify-between animate-fade-in">
          <div>
            <h1 class="text-3xl font-bold">
              <span class="stat-value ml-2">Krado</span>
              <span class="text-white">Dashboard</span>
            </h1>
            <p class="text-text-muted text-sm mt-1">Sistema de monitoreo en tiempo real</p>
          </div>
          
          <!-- Search Bar -->
          <div class="search-container">
            <input type="text" 
                   id="deviceSearch"
                   placeholder="Buscar dispositivo..."
                   class="search-input"
                   pattern="[0-9]*"
                   inputmode="numeric">
            <button id="searchBtn" class="search-btn" title="Buscar">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </button>
          </div>
          
          <div class="flex items-center gap-4">
            <!-- Status indicator -->
            <div class="flex items-center gap-2 px-4 py-2 rounded-lg glass-card">
              <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
              <span class="text-sm text-text-secondary">Conectado</span>
            </div>
            
            <!-- User profile -->
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary-dark shadow-glow"></div>
          </div>
        </header>
        
        <!-- Main Grid -->
        <div class="flex-1 overflow-hidden">
          
          <!-- 3D View -->
          <div id="view3D" class="h-full grid grid-cols-12 gap-6">
            
            <!-- 3D Viewer (Main) -->
            <div class="col-span-8 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in">
              <div class="h-full relative">
                <div class="potree_container absolute inset-0">
                  <div id="potree_render_area" class="w-full h-full rounded-2xl" 
                       style="background: radial-gradient(ellipse at center, #1A1A25 0%, #0A0A0F 100%)"></div>
                  <div id="potree_sidebar_container"></div>
                </div>
                
                <!-- Overlay controls -->
                <div class="absolute top-4 left-4 flex gap-2">
                  <button class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Zoom
                  </button>
                  <button class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Resetear
                  </button>
                </div>
                
                <!-- Device Legend -->
                <div id="deviceLegend" class="absolute bottom-4 left-4 device-legend rounded-lg px-4 py-3 text-xs">
                  <div class="font-semibold text-white mb-2">Dispositivos activos</div>
                  <div id="legendContent" class="space-y-1"></div>
                </div>
              </div>
            </div>
            
            <!-- Right Panel -->
            <div class="col-span-4 flex flex-col gap-6 overflow-hidden">
              
              <!-- Map Card -->
              <div class="flex-1 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in" style="animation-delay: 0.1s">
                <div class="h-full relative">
                  <div id="map_container" class="w-full h-full rounded-2xl"></div>
                  
                  <!-- Map overlay -->
                  <div class="absolute top-4 left-4 right-4">
                    <div class="bg-bg-dark/80 backdrop-blur-sm rounded-lg px-3 py-2 border border-border-subtle">
                      <p class="text-xs text-text-muted">Ubicaci√≥n actual</p>
                      <p class="text-sm font-medium text-primary-light">Lat: --, Lng: --</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Stats Grid -->
              <div class="grid grid-cols-2 gap-4">
                <!-- Stat Card 1 -->
                <div class="glass-card rounded-xl p-4 shadow-card animate-fade-in" style="animation-delay: 0.2s">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs uppercase tracking-wider">Velocidad</span>
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                  </div>
                  <p class="text-2xl font-bold stat-value">0.0</p>
                  <p class="text-xs text-text-secondary">km/h</p>
                </div>
                
                <!-- Stat Card 2 -->
                <div class="glass-card rounded-xl p-4 shadow-card animate-fade-in" style="animation-delay: 0.3s">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs uppercase tracking-wider">Altitud</span>
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                    </svg>
                  </div>
                  <p class="text-2xl font-bold stat-value">--</p>
                  <p class="text-xs text-text-secondary">metros</p>
                </div>
              </div>
              
              <!-- Device Details -->
              <div id="details_card" class="glass-card rounded-2xl p-6 shadow-card animate-fade-in" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-white">Detalles del dispositivo</h3>
                  <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                </div>
                
                <div id="device_details" class="space-y-3 text-sm">
                  <div class="flex items-center justify-between py-2 border-b border-border-subtle">
                    <span class="text-text-muted">Estado</span>
                    <span class="text-text-secondary">Sin conexi√≥n</span>
                  </div>
                  <p class="text-center text-text-muted py-8">
                    Haz clic en un marcador para ver informaci√≥n
                  </p>
                </div>
                
                <button id="trackingBtn" 
                        class="mt-4 w-full py-2.5 btn-primary rounded-lg text-sm font-medium hidden">
                  Iniciar seguimiento
                </button>
              </div>
              
            </div>
          </div>
          
          <!-- 2D Map View -->
          <div id="view2D" class="h-full grid grid-cols-12 gap-6 hidden">
            
            <!-- Large Map -->
            <div class="col-span-8 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in">
              <div class="h-full relative">
                <div id="fullmap_container" class="w-full h-full rounded-2xl"></div>
                
                <!-- Map Controls -->
                <div class="absolute top-4 left-4 flex gap-2">
                  <button id="centerMapBtn" class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Centrar
                  </button>
                  <button id="fitBoundsBtn" class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                    </svg>
                    Ajustar vista
                  </button>
                </div>
                
                <!-- Map Info -->
                <div class="absolute top-4 right-4">
                  <div class="bg-bg-dark/80 backdrop-blur-sm rounded-lg px-3 py-2 border border-border-subtle">
                    <p class="text-xs text-text-muted">Dispositivos visibles</p>
                    <p id="visibleDevicesCount" class="text-sm font-medium text-primary-light">--</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Device List Panel -->
            <div class="col-span-4 flex flex-col gap-6 overflow-hidden">
              
              <!-- Device List -->
              <div class="flex-1 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in" style="animation-delay: 0.1s">
                <div class="h-full flex flex-col">
                  <div class="p-4 border-b border-border-subtle">
                    <h3 class="text-lg font-semibold text-white">Lista de dispositivos</h3>
                    <p class="text-text-muted text-sm mt-1">Dispositivos detectados en tiempo real</p>
                  </div>
                  
                  <div class="flex-1 overflow-y-auto p-4">
                    <div id="deviceList" class="space-y-3"></div>
                  </div>
                </div>
              </div>
              
              <!-- Map Statistics -->
              <div class="grid grid-cols-1 gap-4">
                <!-- Active Devices Stat -->
                <div class="glass-card rounded-xl p-4 shadow-card animate-fade-in" style="animation-delay: 0.2s">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs uppercase tracking-wider">Dispositivos activos</span>
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                    </svg>
                  </div>
                  <p id="activeDevicesCount" class="text-2xl font-bold stat-value">0</p>
                  <p class="text-xs text-text-secondary">en l√≠nea</p>
                </div>
              </div>
              
            </div>
          </div>

          <!-- Analysis View -->
          <div id="viewAnalysis" class="h-full grid grid-cols-12 gap-6 hidden">
            
            <!-- 3D Viewer (Reused from main view) -->
            <div class="col-span-8 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in">
              <div class="h-full relative">
                <!-- We'll reuse the same potree container from main view -->
                <div id="potree_container_shared" class="absolute inset-0">
                  <!-- The main potree viewer will be moved here when in analysis mode -->
                </div>
                
                <!-- Analysis Overlay controls -->
                <div class="absolute top-4 left-4 flex gap-2">
                  <button class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    An√°lisis
                  </button>
                  <button class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Exportar
                  </button>
                </div>
                
                <!-- Analysis Device Legend -->
                <div id="deviceLegendAnalysis" class="absolute bottom-4 left-4 device-legend rounded-lg px-4 py-3 text-xs">
                  <div class="font-semibold text-white mb-2">Dispositivos en an√°lisis</div>
                  <div id="legendContentAnalysis" class="space-y-1"></div>
                </div>
              </div>
            </div>
            
            <!-- Right Panel for Analysis -->
            <div class="col-span-4 flex flex-col gap-6 overflow-hidden">
              
              <!-- Mini Map (Reused) -->
              <div class="flex-1 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in" style="animation-delay: 0.1s">
                <div class="h-full relative">
                  <div id="map_container_analysis" class="w-full h-full rounded-2xl"></div>
                  
                  <!-- Analysis Map overlay -->
                  <div class="absolute top-4 left-4 right-4">
                    <div class="bg-bg-dark/80 backdrop-blur-sm rounded-lg px-3 py-2 border border-border-subtle">
                      <p class="text-xs text-text-muted">An√°lisis espacial</p>
                      <p class="text-sm font-medium text-primary-light">Datos: --</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Analysis Request Form -->
              <div class="glass-card rounded-2xl p-4 shadow-card animate-fade-in" style="animation-delay: 0.15s">
                <div class="mb-4">
                  <h3 class="text-lg font-semibold text-white mb-2">Par√°metros de Consulta</h3>
                  <p class="text-text-muted text-sm">Configure los par√°metros para la consulta de an√°lisis</p>
                </div>
                
                <form id="analysisForm" class="space-y-4">
                  <!-- Device ID Input -->
                  <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">ID del Dispositivo</label>
                    <input 
                      type="text" 
                      id="deviceIdInput" 
                      value="3014344057"
                      class="w-full px-3 py-2 input-dark rounded-lg text-sm font-mono"
                      placeholder="Ingrese el ID del dispositivo">
                  </div>
                  
                  <!-- Date and Time Selectors -->
                  <div class="grid grid-cols-1 gap-3">
                    <div>
                      <label class="block text-sm font-medium text-text-secondary mb-2">Fecha y Hora de Inicio</label>
                      <input 
                        type="datetime-local" 
                        id="startDateTime"
                        class="w-full px-3 py-2 input-dark rounded-lg text-sm"
                        value="2025-05-29T08:00">
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-text-secondary mb-2">Fecha y Hora de Fin</label>
                      <input 
                        type="datetime-local" 
                        id="endDateTime"
                        class="w-full px-3 py-2 input-dark rounded-lg text-sm"
                        value="2025-05-29T18:00">
                    </div>
                  </div>
                  
                  <!-- Limit Input -->
                  <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">L√≠mite de Registros</label>
                    <input 
                      type="number" 
                      id="limitInput" 
                      value="10"
                      min="1"
                      max="1000"
                      class="w-full px-3 py-2 input-dark rounded-lg text-sm">
                  </div>
                  
                  <!-- Submit Button -->
                  <button 
                    type="submit" 
                    id="analyzeBtn"
                    class="w-full py-3 btn-primary rounded-lg text-sm font-medium flex items-center justify-center gap-2">
                    <svg id="analyzeIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span id="analyzeBtnText">Ejecutar An√°lisis</span>
                  </button>
                </form>
              </div>
              
              <!-- Analysis Table -->
              <div class="flex-1 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in" style="animation-delay: 0.2s">
                <div class="h-full flex flex-col">
                  <div class="p-4 border-b border-border-subtle">
                    <h3 class="text-lg font-semibold text-white">Tabla de An√°lisis</h3>
                    <p class="text-text-muted text-sm mt-1">Datos procesados en tiempo real</p>
                  </div>
                  
                  <div class="flex-1 overflow-y-auto">
                    <table id="analysisTable" class="w-full analysis-table">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Par√°metro</th>
                          <th>Valor</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>001</td>
                          <td>Temperatura</td>
                          <td>--</td>
                          <td><span class="text-yellow-400">Pendiente</span></td>
                        </tr>
                        <tr>
                          <td>002</td>
                          <td>Humedad</td>
                          <td>--</td>
                          <td><span class="text-yellow-400">Pendiente</span></td>
                        </tr>
                        <tr>
                          <td>003</td>
                          <td>Presi√≥n</td>
                          <td>--</td>
                          <td><span class="text-yellow-400">Pendiente</span></td>
                        </tr>
                        <tr>
                          <td>004</td>
                          <td>Velocidad Viento</td>
                          <td>--</td>
                          <td><span class="text-yellow-400">Pendiente</span></td>
                        </tr>
                        <tr>
                          <td>005</td>
                          <td>Direcci√≥n Viento</td>
                          <td>--</td>
                          <td><span class="text-yellow-400">Pendiente</span></td>
                        </tr>
                        <tr>
                          <td>006</td>
                          <td>Radiaci√≥n Solar</td>
                          <td>--</td>
                          <td><span class="text-yellow-400">Pendiente</span></td>
                        </tr>
                        <tr>
                          <td>007</td>
                          <td>Precipitaci√≥n</td>
                          <td>--</td>
                          <td><span class="text-yellow-400">Pendiente</span></td>
                        </tr>
                        <tr>
                          <td>008</td>
                          <td>pH Suelo</td>
                          <td>--</td>
                          <td><span class="text-yellow-400">Pendiente</span></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              
            </div>
          </div>

          <!-- Events Gallery View -->
          <div id="viewEvents" class="h-full flex flex-col gap-6 hidden">
            
            <!-- Events Header -->
            <div class="glass-card rounded-2xl p-6 shadow-card animate-fade-in">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-2xl font-bold text-white mb-2">
                    <span class="stat-value">Eventos</span> Reportados
                  </h2>
                  <p class="text-text-muted">Galer√≠a de eventos capturados por el sistema de monitoreo</p>
                </div>
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-2 px-4 py-2 rounded-lg bg-bg-elevated border border-border-subtle">
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span class="text-sm text-text-secondary" id="eventsCount">-- eventos</span>
                  </div>
                  <button class="px-4 py-2 btn-secondary rounded-lg text-sm">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Actualizar
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Events Gallery -->
            <div class="flex-1 overflow-y-auto">
              <div id="eventsGallery" 
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-6">
              </div>
            </div>
            
          </div>
          
        </div>
        
      </div>
    </main>
  </div>
  
  <!-- Scripts externos -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r124/three.min.js"></script>
  <script src="./libs/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>
  
  <!-- AWS SDK for IoT -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1408.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  
  <!-- Axios for API calls -->
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  
  <!-- Main Script -->
  <script type="module">
    /* Projection setup - Define early for GPS visualization */
    proj4.defs('EPSG:32618', '+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs');
    window.wgs84 = 'EPSG:4326';
    window.utm18 = 'EPSG:32618';
    const wgs84 = window.wgs84;
    const utm18 = window.utm18;
    
    /* AWS IoT Core Configuration */
    const AWS_IOT_CONFIG = {
      endpoint: 'ann6k75ioai4b-ats.iot.us-east-1.amazonaws.com',
      region: 'us-east-1',
      accessKeyId: 'AKIAZCRUSKBBQ7DPZY5N',
      secretAccessKey: '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',
      sessionToken: null,
      topic: 'location/+/gps',
      clientId: 'krado-dashboard-' + Math.random().toString(36).substr(2, 9)
    };
    
    /* AWS IoT Core Connection */
    let mqttClient = null;
    let isConnectedToAWS = false;
    
    const connectToAWSIoT = async () => {
      try {        
        // Create signed WebSocket URL for AWS IoT Core MQTT
        const websocketUrl = await createSignedWebSocketUrl();
        
        // Extract hostname and path from the URL for Paho client
        const urlObj = new URL(websocketUrl);
        const hostname = urlObj.hostname;
        const port = 443;
        const path = urlObj.pathname + urlObj.search;
                
        // Create MQTT client using Paho
        mqttClient = new Paho.MQTT.Client(hostname, port, path, AWS_IOT_CONFIG.clientId);
        
        // Set up event handlers
        mqttClient.onConnectionLost = (responseObject) => {
          console.error('‚ùå MQTT Connection lost:', responseObject.errorMessage);
          isConnectedToAWS = false;
          updateConnectionStatus(false);
          
          // Attempt to reconnect
          setTimeout(() => {
            console.log('üîÑ Attempting to reconnect...');
            connectToAWSIoT();
          }, 5000);
        };
        
        mqttClient.onMessageArrived = (message) => {          
          handleAWSIoTMessage(message.destinationName, message.payloadString);
        };
        
        // Connection options
        const connectOptions = {
          useSSL: true,
          mqttVersion: 4,
          onSuccess: () => {
            console.log('‚úÖ Successfully connected to AWS IoT Core MQTT');
            isConnectedToAWS = true;
            updateConnectionStatus(true);
            subscribeToTopic();
          },
          onFailure: (error) => {
            console.error('‚ùå Failed to connect to AWS IoT Core:', error);
            console.error('‚ùå Error details:', error.errorMessage);
            isConnectedToAWS = false;
            updateConnectionStatus(false);
          }
        };
        
        // Connect to AWS IoT Core
        mqttClient.connect(connectOptions);
        
      } catch (error) {
        console.error('‚ùå Failed to setup AWS IoT Core connection:', error);
        console.log('‚è∏Ô∏è AWS IoT setup failed. Please check configuration.');
        isConnectedToAWS = false;
        updateConnectionStatus(false);
      }
    };
    
    const createSignedWebSocketUrl = async () => {
      // AWS IoT WebSocket endpoint format
      const method = 'GET';
      const protocol = 'wss';
      const hostname = AWS_IOT_CONFIG.endpoint;
      const path = '/mqtt';
      
      // Create AWS credentials
      AWS.config.update({
        accessKeyId: AWS_IOT_CONFIG.accessKeyId,
        secretAccessKey: AWS_IOT_CONFIG.secretAccessKey,
        region: AWS_IOT_CONFIG.region
      });
      
      // Get current timestamp
      const now = new Date();
      const amzDate = now.toISOString().replace(/[:\-]|\.\d{3}/g, '');
      const dateStamp = amzDate.substr(0, 8);
      
      // Create credential scope
      const credentialScope = `${dateStamp}/${AWS_IOT_CONFIG.region}/iotdevicegateway/aws4_request`;
      
      // Create canonical query string
      const canonicalQuerystring = [
        'X-Amz-Algorithm=AWS4-HMAC-SHA256',
        `X-Amz-Credential=${encodeURIComponent(AWS_IOT_CONFIG.accessKeyId + '/' + credentialScope)}`,
        `X-Amz-Date=${amzDate}`,
        'X-Amz-SignedHeaders=host'
      ].join('&');
      
      // Create canonical request
      const canonicalHeaders = `host:${hostname}\n`;
      const signedHeaders = 'host';
      const payloadHash = 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855';
      
      const canonicalRequest = [
        method,
        path,
        canonicalQuerystring,
        canonicalHeaders,
        signedHeaders,
        payloadHash
      ].join('\n');
      
      // Create string to sign
      const algorithm = 'AWS4-HMAC-SHA256';
      const stringToSign = [
        algorithm,
        amzDate,
        credentialScope,
        await sha256(canonicalRequest)
      ].join('\n');
      
      // Create signing key
      const signingKey = await getSignatureKey(
        AWS_IOT_CONFIG.secretAccessKey,
        dateStamp,
        AWS_IOT_CONFIG.region,
        'iotdevicegateway'
      );
      
      // Create signature
      const signature = await hmacSha256Hex(signingKey, stringToSign);
      
      // Build final URL
      const finalUrl = `${protocol}://${hostname}${path}?${canonicalQuerystring}&X-Amz-Signature=${signature}`;
      
      return finalUrl;
    };
    
    // Crypto helper functions
    const sha256 = async (message) => {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    };
    
    const hmacSha256 = async (key, message) => {
      const cryptoKey = await crypto.subtle.importKey(
        'raw',
        key,
        { name: 'HMAC', hash: 'SHA-256' },
        false,
        ['sign']
      );
      const signature = await crypto.subtle.sign('HMAC', cryptoKey, new TextEncoder().encode(message));
      return new Uint8Array(signature);
    };
    
    const hmacSha256Hex = async (key, message) => {
      const signature = await hmacSha256(key, message);
      return Array.from(signature).map(b => b.toString(16).padStart(2, '0')).join('');
    };
    
    const getSignatureKey = async (key, dateStamp, regionName, serviceName) => {
      const kDate = await hmacSha256(new TextEncoder().encode('AWS4' + key), dateStamp);
      const kRegion = await hmacSha256(kDate, regionName);
      const kService = await hmacSha256(kRegion, serviceName);
      const kSigning = await hmacSha256(kService, 'aws4_request');
      return kSigning;
    };
    
    const subscribeToTopic = () => {
      if (!isConnectedToAWS || !mqttClient) {
        console.error('‚ùå Cannot subscribe: Not connected to AWS IoT');
        return;
      }
      
      try {        
        mqttClient.subscribe(AWS_IOT_CONFIG.topic, {
          onSuccess: () => {
            console.log(`‚úÖ Successfully subscribed to topic: ${AWS_IOT_CONFIG.topic}`);
          },
          onFailure: (error) => {
            console.error(`‚ùå Failed to subscribe to topic ${AWS_IOT_CONFIG.topic}:`, error);
          }
        });
        
      } catch (error) {
        console.error('‚ùå Error during subscription:', error);
      }
    };
    
    const handleAWSIoTMessage = (topic, payloadString) => {
      try {        
        // Parse the incoming message
        let message;
        try {
          message = JSON.parse(payloadString);
        } catch (parseError) {
          console.error('‚ùå JSON Parse Error:', parseError);
          return;
        }
        processNewCoordinate(message);
        
        
      } catch (error) {
        console.error('‚ùå Error processing AWS IoT message:', error);
      }
    };
    
    const processNewCoordinate = (coord) => {      
      // Validate coordinate structure
      if (!coord || typeof coord !== 'object') {
        console.warn('‚ùå Invalid coordinate: not an object', coord);
        return;
      }
      
      if (!coord.latitude || !coord.longitude || !coord.deviceId) {
        console.warn('‚ùå Invalid coordinate data - missing required fields:', coord);
        return;
      }
      
      let isNewDevice = false;
      
      // Add to device groups if new device
      if (!deviceGroups[coord.deviceId]) {
        deviceGroups[coord.deviceId] = [];
        isNewDevice = true;
        
        // Assign color to new device
        const deviceIndex = Object.keys(deviceGroups).length - 1;
        window.deviceColorMap[coord.deviceId] = deviceColors[deviceIndex % deviceColors.length];
        
        // Update device index to track latest position
        deviceCurrentIndex[coord.deviceId] = 0;
        
        // Update device IDs
        updateDeviceIds();
      }
      
      // Add coordinate to device path
      deviceGroups[coord.deviceId].push(coord);
      
      // Convert coordinate for 3D positioning
      const [x, y] = proj4(window.wgs84 || 'EPSG:4326', window.utm18 || 'EPSG:32618', [coord.longitude, coord.latitude]);
      const convertedCoord = { x, y, z: coord.altitude+30 || 0, ...coord };
      
      if (!devicePaths[coord.deviceId]) {
        devicePaths[coord.deviceId] = [];
      }
      devicePaths[coord.deviceId].push(convertedCoord);
      
      // Update current index to point to the latest coordinate
      deviceCurrentIndex[coord.deviceId] = devicePaths[coord.deviceId].length - 1;
      
      // NOW create markers for new device (after coordinate data is available)
      if (isNewDevice) {
        createMarkersForNewDevice(coord.deviceId);
      } else {
        // Update existing markers position
        updateMarkerPositions(coord.deviceId);
      }
      
      // Update UI immediately
      updateDeviceVisibility();
      updateDeviceList();
      updateLegend();
      
      // Update details if this device is currently selected
      const detailsEl = document.getElementById('device_details');
      if (detailsEl && detailsEl.dataset.activeDevice === coord.deviceId) {
        renderDetails(coord.deviceId, coord);
      }
      
      // Update tracking if enabled for this device
      if (window.trackingEnabled && window.trackedDeviceId === coord.deviceId) {
        handleTracking(coord.deviceId);
      }
      
      // Pan map to new device location immediately (only for new devices)
      if (window.map && isNewDevice) {
        window.map.setView([coord.latitude, coord.longitude], Math.max(window.map.getZoom(), 16), {
          animate: true,
          duration: 1
        });
      }
    };
    
    const updateMarkerPositions = (deviceId) => {
      if (!devicePaths[deviceId] || devicePaths[deviceId].length === 0) return;
      
      const currentIndex = deviceCurrentIndex[deviceId];
      const currentPos = devicePaths[deviceId][currentIndex];
      
      // Update 2D marker position (small map)
      if (window.markers2D && window.markers2D[deviceId]) {
        window.markers2D[deviceId].setLatLng([currentPos.latitude, currentPos.longitude]);
      }
      
      // Update analysis map marker position
      if (window.markers2DAnalysis && window.markers2DAnalysis[deviceId]) {
        window.markers2DAnalysis[deviceId].setLatLng([currentPos.latitude, currentPos.longitude]);
      }
      
      // Update full map marker position
      if (typeof fullMapMarkers !== 'undefined' && fullMapMarkers[deviceId]) {
        fullMapMarkers[deviceId].setLatLng([currentPos.latitude, currentPos.longitude]);
      }
      
      // Update 3D marker position
      if (window.markers3D && window.markers3D[deviceId]) {
        const marker3D = window.markers3D[deviceId];
        
        // Apply height offset if available
        let adjustedZ = currentPos.z;
        if (window.heightOffsets && window.heightOffsets[deviceId] !== undefined) {
          adjustedZ += window.heightOffsets[deviceId];
        }
        
        marker3D.geometry.attributes.position.set([currentPos.x, currentPos.y, adjustedZ]);
        marker3D.geometry.attributes.position.needsUpdate = true;
        marker3D.geometry.computeBoundingSphere();
        marker3D.material.opacity = 1; // Ensure it's visible
      }
    };
    
    const handleTracking = (deviceId) => {
      const currentIndex = deviceCurrentIndex[deviceId];
      const trackedPos = devicePaths[deviceId][currentIndex];
      
      if (trackedPos && window.markers2D && window.markers2D[deviceId]) {
        window.map.panTo([trackedPos.latitude, trackedPos.longitude], { animate: true, duration: 1 });
        
        if (window.cameraOffset) {
          const markerPos = new THREE.Vector3(trackedPos.x, trackedPos.y, trackedPos.z);  
          viewer.scene.view.position.copy(markerPos.clone().add(window.cameraOffset));
          viewer.scene.view.lookAt(markerPos);
          viewer.scene.view.updateCamera(viewer.scene.camera);
        }
      }
    };
    
    const updateDeviceIds = () => {
      const newDeviceIds = Object.keys(deviceGroups);
      
      // Add new devices to filtered list if not searching
      const searchValue = document.getElementById('deviceSearch').value.trim();
      if (searchValue === '') {
        filteredDeviceIds = [...newDeviceIds];
        console.log('‚úÖ No search filter - showing all devices:', filteredDeviceIds);
      } else {
        filteredDeviceIds = newDeviceIds.filter(deviceId => deviceId.includes(searchValue));
        console.log(`üîç Search filter "${searchValue}" applied. Filtered devices:`, filteredDeviceIds);
      }
      
      // Update the global deviceIds array
      deviceIds.length = 0; // Clear array
      deviceIds.push(...newDeviceIds);
      console.log('üìù Updated global deviceIds:', deviceIds);
    };
    
    const createMarkersForNewDevice = (deviceId) => {
      if (!deviceGroups[deviceId] || deviceGroups[deviceId].length === 0) {
        console.warn(`‚ùå Cannot create markers for ${deviceId}: no coordinate data`);
        return;
      }
      
      const coords = deviceGroups[deviceId];
      const color = window.deviceColorMap[deviceId];
      
      // Create 2D marker for small map
      if (window.markers2D) {
        if (!window.markers2D[deviceId]) {
          window.markers2D[deviceId] = L.circleMarker([coords[0].latitude, coords[0].longitude], {
            radius: 8,
            color: color.light,
            fillColor: color.base,
            fillOpacity: 0.8,
            weight: 2
          });
          
          if (filteredDeviceIds.includes(deviceId)) {
            window.markers2D[deviceId].addTo(window.map);
          }
        }
      } else {
        console.warn(`‚ùå window.markers2D is not available`);
      }

      // Create 2D marker for analysis map
      if (window.markers2DAnalysis) {
        if (!window.markers2DAnalysis[deviceId]) {
          window.markers2DAnalysis[deviceId] = L.circleMarker([coords[0].latitude, coords[0].longitude], {
            radius: 8,
            color: color.light,
            fillColor: color.base,
            fillOpacity: 0.8,
            weight: 2
          });
          
          if (filteredDeviceIds.includes(deviceId)) {
            window.markers2DAnalysis[deviceId].addTo(window.mapAnalysis);
          }
        }
      } else {
        console.warn(`‚ùå window.markers2DAnalysis is not available`);
      }
      
      // Create full map marker
      if (typeof fullMapMarkers !== 'undefined') {
        if (!fullMapMarkers[deviceId]) {
          const marker = L.circleMarker([coords[0].latitude, coords[0].longitude], {
            radius: 10,
            color: color.light,
            fillColor: color.base,
            fillOpacity: 0.8,
            weight: 3
          });
          
          marker.bindPopup(`
            <div class="text-sm">
              <div class="font-bold mb-1" style="color: ${color.light}">
                Dispositivo ${deviceId.slice(-4)}
              </div>
              <div class="space-y-1 text-xs">
                <div>ID: ${deviceId}</div>
                <div>Lat: ${coords[0].latitude.toFixed(6)}</div>
                <div>Lng: ${coords[0].longitude.toFixed(6)}</div>
                <div>Alt: ${coords[0].altitude.toFixed(2)} m</div>
              </div>
            </div>
          `, {
            className: 'tooltip-glow'
          });
          
          fullMapMarkers[deviceId] = marker;
          
          if (filteredDeviceIds.includes(deviceId) && typeof fullMap !== 'undefined' && fullMap) {
            marker.addTo(fullMap);
          }
        }
      }
      
      // Create 3D marker if the 3D scene is ready
      if (window.markers3D && typeof viewer !== 'undefined' && viewer.scene) {
        console.log(`üéØ 3D scene is ready, creating 3D marker for device ${deviceId}`);
        create3DMarkerForDevice(deviceId);
      }      
    };
    
    const create3DMarkerForDevice = (deviceId) => {
      if (!deviceGroups[deviceId] || deviceGroups[deviceId].length === 0) return;
      if (window.markers3D[deviceId]) return; // Already exists
      
      const color = window.deviceColorMap[deviceId];
      
      // Create texture for the marker (same function used in main 3D creation)
      const makeTexture = (color) => {
        const s = 256, c = document.createElement('canvas');
        c.width = c.height = s;
        const ctx = c.getContext('2d');
        
        // Parse hex color
        const r = parseInt(color.base.slice(1,3), 16);
        const g = parseInt(color.base.slice(3,5), 16);
        const b = parseInt(color.base.slice(5,7), 16);
        
        // Outer glow
        const g1 = ctx.createRadialGradient(s/2, s/2, 0, s/2, s/2, s/2);
        g1.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.3)`);
        g1.addColorStop(0.5, `rgba(${r}, ${g}, ${b}, 0.1)`);
        g1.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);
        ctx.fillStyle = g1;
        ctx.fillRect(0, 0, s, s);
        
        // Inner circle
        const g2 = ctx.createRadialGradient(s/2, s/2, s*0.15, s/2, s/2, s*0.25);
        g2.addColorStop(0, color.light);
        g2.addColorStop(1, color.base);
        ctx.fillStyle = g2;
        ctx.beginPath();
        ctx.arc(s/2, s/2, s*0.2, 0, Math.PI * 2);
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
      };
      
      const geom = new THREE.BufferGeometry().setAttribute('position', 
        new THREE.BufferAttribute(new Float32Array(3), 3));
      geom.computeBoundingSphere();
      
      const mat = new THREE.PointsMaterial({
        map: makeTexture(color),
        size: 32,
        sizeAttenuation: false,
        transparent: true,
        opacity: 1,
        depthTest: false,
        depthWrite: false
      });
      
      const marker = new THREE.Points(geom, mat);
      marker.frustumCulled = false;
      marker.renderOrder = 9999;
      marker.userData.deviceId = deviceId;
      
      // Set initial position if we have coordinate data
      if (devicePaths[deviceId] && devicePaths[deviceId].length > 0) {
        const currentIndex = deviceCurrentIndex[deviceId];
        const pos = devicePaths[deviceId][currentIndex];
        
        // Apply height offset if available
        let adjustedZ = pos.z;
        if (window.heightOffsets && window.heightOffsets[deviceId] !== undefined) {
          adjustedZ += window.heightOffsets[deviceId];
        }
        
        marker.geometry.attributes.position.set([pos.x, pos.y, adjustedZ]);
        marker.geometry.attributes.position.needsUpdate = true;
        marker.geometry.computeBoundingSphere();
      }
      
      window.markers3D[deviceId] = marker;
      
      // Add to scene if markerGroup exists
      if (window.markerGroup) {
        window.markerGroup.add(marker);
      } else if (viewer.scene && viewer.scene.scene) {
        viewer.scene.scene.add(marker);
      }      
    };
    
    const updateConnectionStatus = (connected) => {
      const statusIndicator = document.querySelector('.bg-green-500');
      const statusText = document.querySelector('.text-text-secondary');
      
      if (connected) {
        statusIndicator.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
        statusText.textContent = 'AWS IoT Conectado';
      } else {
        statusIndicator.className = 'w-2 h-2 rounded-full bg-red-500';
        statusText.textContent = 'Desconectado';
      }
    };
    
    /* View Management */
    let currentView = '3d';
    let fullMap = null;
    let fullMapMarkers = {};
    
    const switchView = (view) => {
      const view3D = document.getElementById('view3D');
      const view2D = document.getElementById('view2D');
      const viewAnalysis = document.getElementById('viewAnalysis');
      const viewEvents = document.getElementById('viewEvents');
      const sidebarIcons = document.querySelectorAll('.sidebar-icon[data-view]');
      
      // Clear analysis visualization when leaving analysis view
      if (currentView === 'analysis' && view !== 'analysis') {
        clearAnalysisVisualization();
        clear2DGPSVisualization();
      }
      
      // Remove active class from all view icons
      sidebarIcons.forEach(icon => icon.classList.remove('active'));
      
      // Hide all views
      view3D.classList.add('hidden');
      view2D.classList.add('hidden');
      viewAnalysis.classList.add('hidden');
      viewEvents.classList.add('hidden');
      
      if (view === '3d') {
        view3D.classList.remove('hidden');
        document.querySelector('[data-view="3d"]').classList.add('active');
        currentView = '3d';
        
        // Move Potree container back to 3D view
        const potreeContainer = document.querySelector('.potree_container');
        const view3DCard = view3D.querySelector('.glass-card > div');
        if (potreeContainer && view3DCard) {
          if (potreeContainer.parentNode !== view3DCard) {
            view3DCard.appendChild(potreeContainer);
          }
        }
        
        // Invalidate small map size after view switch
        setTimeout(() => {
          if (window.map) {
            window.map.invalidateSize();
          }
          if (viewer && viewer.resize) {
            viewer.resize();
          }
        }, 300);
      } else if (view === '2d') {
        view2D.classList.remove('hidden');
        document.querySelector('[data-view="2d"]').classList.add('active');
        currentView = '2d';
        
        // Initialize or refresh full map
        setTimeout(() => {
          initializeFullMap();
        }, 300);
      } else if (view === 'analysis') {
        viewAnalysis.classList.remove('hidden');
        document.querySelector('[data-view="analysis"]').classList.add('active');
        currentView = 'analysis';
        
        // Move Potree container to analysis view
        const potreeContainer = document.querySelector('.potree_container');
        const analysisSharedContainer = document.getElementById('potree_container_shared');
        if (potreeContainer && analysisSharedContainer) {
          if (potreeContainer.parentNode !== analysisSharedContainer) {
            analysisSharedContainer.appendChild(potreeContainer);
          }
        }
        
        // Initialize analysis view
        setTimeout(() => {
          initializeAnalysisView();
          // Set up form handler when entering analysis view
          setupAnalysisForm();
          if (viewer && viewer.resize) {
            viewer.resize();
          }
        }, 300);
      } else if (view === 'events') {
        initializeEventsView();  
        viewEvents.classList.remove('hidden');
        document.querySelector('[data-view="events"]').classList.add('active');
        currentView = 'events';        
      }
    };
    
    // Add click handlers to sidebar icons
    document.querySelectorAll('.sidebar-icon[data-view]').forEach(icon => {
      icon.addEventListener('click', () => {
        const view = icon.getAttribute('data-view');
        switchView(view);
      });
    });
    
    /* Analysis View Initialization */
    const initializeAnalysisView = () => {      
      // Initialize analysis map if not already done
      if (!window.mapAnalysis) {
        const defaultCenter = [11.026178, -74.800039]; // Default coordinates
        let initialCenter = defaultCenter;
        let initialZoom = 16;
        
        // If we have devices, center on the first one
        if (filteredDeviceIds.length > 0 && deviceGroups[filteredDeviceIds[0]]) {
          const firstCoord = deviceGroups[filteredDeviceIds[0]][0];
          if (firstCoord) {
            initialCenter = [firstCoord.latitude, firstCoord.longitude];
          }
        }
        
        // Mapa de an√°lisis (map_container_analysis)
        window.mapAnalysis = L.map('map_container_analysis', {
          zoomControl: false,
          attributionControl: false,
          scrollWheelZoom: false
        }).setView(initialCenter, initialZoom);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(window.mapAnalysis);
        
        // Initialize empty markers object for analysis
        window.markers2DAnalysis = {};
        
        // Create markers for analysis map
        Object.entries(deviceGroups).forEach(([deviceId, coords]) => {
          if (coords.length === 0) return;
          
          const color = window.deviceColorMap[deviceId];
          const marker = L.circleMarker([coords[0].latitude, coords[0].longitude], {
            radius: 8,
            color: color.light,
            fillColor: color.base,
            fillOpacity: 0.8,
            weight: 2
          });
          
          window.markers2DAnalysis[deviceId] = marker;
          
          if (filteredDeviceIds.includes(deviceId)) {
            marker.addTo(window.mapAnalysis);
          }
        });        
      } else {
        // Invalidate size and update markers
        window.mapAnalysis.invalidateSize();
        
        // Update markers visibility based on current filter
        Object.entries(window.markers2DAnalysis).forEach(([deviceId, marker]) => {
          if (marker) {
            if (filteredDeviceIds.includes(deviceId)) {
              marker.addTo(window.mapAnalysis);
            } else {
              marker.remove();
            }
          }
        });
      }
      
      // Update analysis legend
      updateAnalysisLegend();
    };
    
    const updateAnalysisLegend = () => {
      const legendContent = document.getElementById('legendContentAnalysis');
      if (!legendContent) return;
      
      legendContent.innerHTML = '';
      
      filteredDeviceIds.forEach(deviceId => {
        const color = window.deviceColorMap[deviceId];
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
          <span class="device-indicator" style="background: ${color.base};"></span>
          <span class="text-text-secondary">Dispositivo ${deviceId.slice(-4)}</span>
        `;
        legendContent.appendChild(div);
      });
    };
    
    /* GPS Data and Device Grouping */
    // All data will come from real-time AWS IoT events
    const deviceGroups = {};
    const deviceColors = [
      { base: '#8B5CF6', light: '#A78BFA' },    // Primary purple
      { base: '#6366F1', light: '#818CF8' },    // Indigo
      { base: '#9333EA', light: '#A855F7' },    // Violet
      { base: '#7C3AED', light: '#A78BFA' },    // Dark purple
      { base: '#4F46E5', light: '#6366F1' },    // Dark indigo
      { base: '#7E22CE', light: '#9333EA' },    // Dark violet
      { base: '#A855F7', light: '#C084FC' },    // Light violet
      { base: '#818CF8', light: '#A5B4FC' }     // Light indigo
    ];
    
    const deviceColorMap = {};
    const devicePaths = {};
    let deviceIds = [];
    const deviceCurrentIndex = {}; // Track current position for each device
    
    // Make globally accessible for GPS visualization
    window.deviceColorMap = deviceColorMap;
    window.deviceColors = deviceColors;
    
    /* Initialize Data Source */
    const initializeDataSource = async () => {
      console.log('üöÄ Initializing AWS IoT Core connection...');
      await connectToAWSIoT();
    };
    
    /* Device List Management */
    const updateDeviceList = () => {
      const deviceList = document.getElementById('deviceList');
      const activeDevicesCount = document.getElementById('activeDevicesCount');
      const visibleDevicesCount = document.getElementById('visibleDevicesCount');
      
      if (!deviceList) return;
      
      deviceList.innerHTML = '';
      
      filteredDeviceIds.forEach(deviceId => {
        const color = window.deviceColorMap[deviceId];
        const currentIndex = deviceCurrentIndex[deviceId] || 0;
        const currentCoord = devicePaths[deviceId][currentIndex];
        
        if (!currentCoord) return; // Skip if no data yet
        
        const deviceItem = document.createElement('div');
        deviceItem.className = 'device-item';
        deviceItem.dataset.deviceId = deviceId;
        
        deviceItem.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="device-status"></div>
              <span class="font-medium text-white">Dispositivo ${deviceId.slice(-4)}</span>
            </div>
            <div class="device-indicator" style="background: ${color.base}; width: 10px; height: 10px;"></div>
          </div>
          <div class="text-xs text-text-muted space-y-1">
            <div>ID: <span class="text-text-secondary font-mono">${deviceId}</span></div>
            <div>Lat: <span class="text-primary-light">${currentCoord.latitude.toFixed(6)}</span></div>
            <div>Lng: <span class="text-primary-light">${currentCoord.longitude.toFixed(6)}</span></div>
            ${currentCoord.custom && currentCoord.custom.heartRate ? 
              `<div>HR: <span class="text-green-400">${currentCoord.custom.heartRate} bpm</span></div>` : ''}
          </div>
        `;
        
        deviceItem.addEventListener('click', () => {
          // Remove active class from all items
          document.querySelectorAll('.device-item').forEach(item => 
            item.classList.remove('active'));
          deviceItem.classList.add('active');
          
          // Center map on selected device if in 2D view
          if (currentView === '2d' && fullMap) {
            fullMap.setView([currentCoord.latitude, currentCoord.longitude], 18, {
              animate: true,
              duration: 1
            });
          }
          
          // Update device details in 3D view
          if (currentView === '3d') {
            const detailsEl = document.getElementById('device_details');
            const trackingBtn = document.getElementById('trackingBtn');
            
            detailsEl.dataset.activeDevice = deviceId;
            window.trackedDeviceId = deviceId;
            trackingBtn.classList.remove('hidden');
            
            // Update details
            renderDetails(deviceId, currentCoord);
          }
        });
        
        deviceList.appendChild(deviceItem);
      });
      
      // Update counters
      if (activeDevicesCount) {
        activeDevicesCount.textContent = filteredDeviceIds.length;
      }
      if (visibleDevicesCount) {
        visibleDevicesCount.textContent = filteredDeviceIds.length;
      }
    };
    
    /* Full Map Initialization */
    const initializeFullMap = () => {
      if (fullMap) {
        fullMap.invalidateSize();
        
        // Update markers visibility based on current filter
        Object.entries(fullMapMarkers).forEach(([deviceId, marker]) => {
          if (marker) {
            if (filteredDeviceIds.includes(deviceId)) {
              marker.addTo(fullMap);
            } else {
              marker.remove();
            }
          }
        });
        
        return;
      }
      
      const defaultCenter = [11.026178, -74.800039]; // Default coordinates
      let initialCenter = defaultCenter;
      let initialZoom = 16;
      
      // If we have devices, center on the first one
      if (filteredDeviceIds.length > 0 && deviceGroups[filteredDeviceIds[0]]) {
        const firstCoord = deviceGroups[filteredDeviceIds[0]][0];
        if (firstCoord) {
          initialCenter = [firstCoord.latitude, firstCoord.longitude];
        }
      }
      
      // Mapa completo (fullmap_container)
      fullMap = L.map('fullmap_container', {
        zoomControl: true,
        attributionControl: false,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        touchZoom: true,
        boxZoom: true,
        keyboard: true
      }).setView(initialCenter, initialZoom);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(fullMap);
      
      // Create markers for full map
      Object.entries(deviceGroups).forEach(([deviceId, coords]) => {
        if (coords.length === 0) return;
        
        const color = window.deviceColorMap[deviceId];
        const marker = L.circleMarker([coords[0].latitude, coords[0].longitude], {
          radius: 10,
          color: color.light,
          fillColor: color.base,
          fillOpacity: 0.8,
          weight: 3
        });
        
        // Add popup
        marker.bindPopup(`
          <div class="text-sm">
            <div class="font-bold mb-1" style="color: ${color.light}">
              Dispositivo ${deviceId.slice(-4)}
            </div>
            <div class="space-y-1 text-xs">
              <div>ID: ${deviceId}</div>
              <div>Lat: ${coords[0].latitude.toFixed(6)}</div>
              <div>Lng: ${coords[0].longitude.toFixed(6)}</div>
              <div>Alt: ${coords[0].altitude.toFixed(2)} m</div>
            </div>
          </div>
        `, {
          className: 'tooltip-glow'
        });
        
        fullMapMarkers[deviceId] = marker;
        
        if (filteredDeviceIds.includes(deviceId)) {
          marker.addTo(fullMap);
        }
      });
      
      // Add map control handlers
      document.getElementById('centerMapBtn')?.addEventListener('click', () => {
        if (filteredDeviceIds.length > 0) {
          const firstDevice = filteredDeviceIds[0];
          const currentIndex = deviceCurrentIndex[firstDevice] || 0;
          const coord = devicePaths[firstDevice][currentIndex];
          if (coord) {
            fullMap.setView([coord.latitude, coord.longitude], 16, { animate: true });
          }
        }
      });
      
      document.getElementById('fitBoundsBtn')?.addEventListener('click', () => {
        if (filteredDeviceIds.length > 0) {
          const bounds = L.latLngBounds();
          filteredDeviceIds.forEach(deviceId => {
            const currentIndex = deviceCurrentIndex[deviceId] || 0;
            const coord = devicePaths[deviceId][currentIndex];
            if (coord) {
              bounds.extend([coord.latitude, coord.longitude]);
            }
          });
          if (bounds.isValid()) {
            fullMap.fitBounds(bounds, { padding: [20, 20], animate: true });
          }
        }
      });
      
      // Update device list
      updateDeviceList();
    };
    
    /* Search functionality */
    let filteredDeviceIds = [];
    
    const deviceSearchInput = document.getElementById('deviceSearch');
    const searchBtn = document.getElementById('searchBtn');
    
    // Only allow numbers in search input
    deviceSearchInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    const performSearch = () => {
      const searchValue = deviceSearchInput.value.trim();
      
      if (searchValue === '') {
        // If search is empty, show all devices
        filteredDeviceIds = [...deviceIds];
      } else {
        // Filter devices that contain the search sequence
        filteredDeviceIds = deviceIds.filter(deviceId => 
          deviceId.includes(searchValue)
        );
      }
      
      updateDeviceVisibility();
    };
    
    // Search on button click
    searchBtn.addEventListener('click', performSearch);
    
    // Search on Enter key press
    deviceSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
    
    const updateDeviceVisibility = () => {
      // Update 3D markers visibility
      if (window.markers3D) {
        Object.entries(window.markers3D).forEach(([deviceId, marker]) => {
          if (marker) {
            marker.visible = filteredDeviceIds.includes(deviceId);
          }
        });
      }
      
      // Update 2D markers visibility (small map)
      if (window.markers2D) {
        Object.entries(window.markers2D).forEach(([deviceId, marker]) => {
          if (marker) {
            if (filteredDeviceIds.includes(deviceId)) {
              marker.addTo(window.map);
            } else {
              marker.remove();
            }
          }
        });
      }

      // Update analysis 2D markers visibility
      if (window.markers2DAnalysis) {
        Object.entries(window.markers2DAnalysis).forEach(([deviceId, marker]) => {
          if (marker) {
            if (filteredDeviceIds.includes(deviceId)) {
              if (window.mapAnalysis) marker.addTo(window.mapAnalysis);
            } else {
              marker.remove();
            }
          }
        });
      }
      
      // Update full map markers visibility
      if (typeof fullMapMarkers !== 'undefined') {
        Object.entries(fullMapMarkers).forEach(([deviceId, marker]) => {
          if (marker) {
            if (filteredDeviceIds.includes(deviceId)) {
              if (typeof fullMap !== 'undefined' && fullMap) marker.addTo(fullMap);
            } else {
              marker.remove();
            }
          }
        });
      }
      
      // Update legend
      updateLegend();
      updateAnalysisLegend();
      
      // Update device list
      updateDeviceList();
      
      // If currently tracked device is filtered out, stop tracking
      if (window.trackedDeviceId && !filteredDeviceIds.includes(window.trackedDeviceId)) {
        window.trackingEnabled = false;
        window.trackedDeviceId = null;
        window.cameraOffset = null;
        const trackingBtn = document.getElementById('trackingBtn');
        if (trackingBtn) {
          trackingBtn.textContent = 'Iniciar seguimiento';
          trackingBtn.classList.remove('btn-secondary');
          trackingBtn.classList.add('btn-primary');
          trackingBtn.classList.add('hidden');
        }
        
        // Clear device details if filtered device was active
        const detailsEl = document.getElementById('device_details');
        if (detailsEl && detailsEl.dataset.activeDevice && !filteredDeviceIds.includes(detailsEl.dataset.activeDevice)) {
          delete detailsEl.dataset.activeDevice;
          detailsEl.innerHTML = `
            <div class="flex items-center justify-between py-2 border-b border-border-subtle">
              <span class="text-text-muted">Estado</span>
              <span class="text-text-secondary">Sin conexi√≥n</span>
            </div>
            <p class="text-center text-text-muted py-8">
              Haz clic en un marcador para ver informaci√≥n
            </p>`;
        }
      }
    };
    
    const updateLegend = () => {
      const legendContent = document.getElementById('legendContent');
      if (!legendContent) return;
      
      legendContent.innerHTML = '';
      
      filteredDeviceIds.forEach(deviceId => {
        const color = window.deviceColorMap[deviceId];
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
          <span class="device-indicator" style="background: ${color.base};"></span>
          <span class="text-text-secondary">Dispositivo ${deviceId.slice(-4)}</span>
        `;
        legendContent.appendChild(div);
      });
    };
    
    // Mapa peque√±o en la vista 3D (map_container)
    const map = L.map('map_container', {
      zoomControl: false,
      attributionControl: false,
      scrollWheelZoom: false
    }).setView([11.026178, -74.800039], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Initialize empty markers object
    const markers2D = {};
    
    // Make markers2D available globally for search functionality
    window.markers2D = markers2D;
    window.map = map;
    
    setTimeout(() => map.invalidateSize(), 400);
    
    /* Tracking state */
    let trackingEnabled = false;
    let cameraOffset = null;
    let trackedDeviceId = null;
    
    // Make tracking variables global for search functionality
    window.trackingEnabled = trackingEnabled;
    window.trackedDeviceId = trackedDeviceId;
    window.cameraOffset = cameraOffset;
    
    const trackingBtn = document.getElementById('trackingBtn');
    trackingBtn.onclick = () => {
      window.trackingEnabled = !window.trackingEnabled;
      trackingBtn.textContent = window.trackingEnabled ? 'Detener seguimiento' : 'Iniciar seguimiento';
      trackingBtn.classList.toggle('btn-primary');
      trackingBtn.classList.toggle('btn-secondary');
      
      if (window.trackingEnabled && window.trackedDeviceId) {
        const currentIndex = deviceCurrentIndex[window.trackedDeviceId] || 0;
        const currentCoord = devicePaths[window.trackedDeviceId][currentIndex];
        if (currentCoord) {
          const camPos = viewer.scene.view.position.clone();
          const markerPos = new THREE.Vector3(currentCoord.x, currentCoord.y, currentCoord.z);
          window.cameraOffset = camPos.sub(markerPos);
        }
      } else {
        window.cameraOffset = null;
      }
    };
    
    /* Details panel helper */
    const renderDetails = (deviceId, coord) => {
      const detailsEl = document.getElementById('device_details');
      const color = window.deviceColorMap[deviceId];
      detailsEl.innerHTML = `
        <div class="space-y-3">
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Dispositivo</span>
            <span class="font-mono" style="color: ${color.base}">${deviceId.slice(-4)}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Latitud</span>
            <span class="font-mono text-primary-light">${coord.latitude.toFixed(6)}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Longitud</span>
            <span class="font-mono text-primary-light">${coord.longitude.toFixed(6)}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Altitud</span>
            <span class="font-mono text-primary-light">${coord.altitude.toFixed(2)} m</span>
          </div>
          ${coord.custom && coord.custom.heartRate ? `
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Frecuencia card√≠aca</span>
            <span class="font-mono text-primary-light">${coord.custom.heartRate} bpm</span>
          </div>` : ''}
          ${coord.custom && coord.custom.steps !== undefined ? `
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Pasos</span>
            <span class="font-mono text-primary-light">${coord.custom.steps}</span>
          </div>` : ''}
          <div class="flex items-center justify-between py-2">
            <span class="text-text-muted">Tiempo</span>
            <span class="text-text-secondary">${new Date().toLocaleTimeString()}</span>
          </div>
        </div>`;
        
      // Update map overlay
      const overlayEl = document.querySelector('.bg-bg-dark\\/80 p');
      if (overlayEl && overlayEl.nextElementSibling) {
        overlayEl.nextElementSibling.textContent = 
          `Lat: ${coord.latitude.toFixed(6)}, Lng: ${coord.longitude.toFixed(6)}`;
      }
        
      // Update stats (example values, modify as needed)
      const statValues = document.querySelectorAll('.stat-value');
      if (statValues[0]) statValues[0].textContent = '0.0'; // Speed
      if (statValues[1]) statValues[1].textContent = coord.altitude.toFixed(1); // Altitude
    };
    
    /* Potree Viewer */
    window.viewer = new Potree.Viewer(document.getElementById('potree_render_area'));
    viewer.useHQ = true;
    viewer.setEDLEnabled(true);
    viewer.setFOV(60);
    viewer.setPointBudget(500000);
    viewer.loadGUI(() => {
      viewer.setLanguage('es');
      $('#menu_appearance').next().show();
    });
    viewer.loadSettingsFromURL();
    
    // Load point cloud
    Potree.loadPointCloud('../../../pointsCloudOfficialFolder/metadata.json', 'malecon', e => {
      const pc = e.pointcloud;
      Object.assign(pc.material, {
        size: 1,
        pointSizeType: Potree.PointSizeType.ADAPTIVE,
        shape: Potree.PointShape.CIRCLE,
        activeAttributeName: 'elevation',
        gradient: Potree.Gradients.VIRIDIS,
        needsUpdate: true
      });
      viewer.scene.addPointCloud(pc);
      viewer.fitToScreen();
      
      /* Create 3D Markers container */
      const markers3D = {};
      const markerGroup = new THREE.Group();
      
      // Modal sphere variables (declared here to be accessible by animation loop)
      let modalEventSphere = null;
      let modalGlowSphere = null;
      
      // Make modal sphere variables globally accessible
      window.modalEventSphere = modalEventSphere;
      window.modalGlowSphere = modalGlowSphere;
      
      // Make markerGroup globally available for new devices
      window.markerGroup = markerGroup;
      
      const makeTexture = (color) => {
        const s = 256, c = document.createElement('canvas');
        c.width = c.height = s;
        const ctx = c.getContext('2d');
        
        // Parse hex color
        const r = parseInt(color.base.slice(1,3), 16);
        const g = parseInt(color.base.slice(3,5), 16);
        const b = parseInt(color.base.slice(5,7), 16);
        
        // Outer glow
        const g1 = ctx.createRadialGradient(s/2, s/2, 0, s/2, s/2, s/2);
        g1.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.3)`);
        g1.addColorStop(0.5, `rgba(${r}, ${g}, ${b}, 0.1)`);
        g1.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);
        ctx.fillStyle = g1;
        ctx.fillRect(0, 0, s, s);
        
        // Inner circle
        const g2 = ctx.createRadialGradient(s/2, s/2, s*0.15, s/2, s/2, s*0.25);
        g2.addColorStop(0, color.light);
        g2.addColorStop(1, color.base);
        ctx.fillStyle = g2;
        ctx.beginPath();
        ctx.arc(s/2, s/2, s*0.2, 0, Math.PI * 2);
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
      };
      
      // Make markers3D available globally for search functionality and new devices
      window.markers3D = markers3D;
      
      viewer.scene.scene.add(markerGroup);
      
      // Create 3D markers for any devices that arrived via IoT before scene was ready
      Object.keys(deviceGroups).forEach(deviceId => {
        if (!markers3D[deviceId]) {
          console.log(`üéØ Creating 3D marker for IoT device that arrived early: ${deviceId}`);
          create3DMarkerForDevice(deviceId);
        }
      });
      
      // Pulsing animation for all markers
      viewer.addEventListener('update', () => {
        const pulse = Math.sin(performance.now() * 0.003) * 0.2 + 0.8;
        Object.values(markers3D).forEach(marker => {
          if (marker.visible) {
            marker.material.opacity = pulse;
            marker.material.size = 32 + Math.sin(performance.now() * 0.006) * 8;
          }
        });
        
        // Animate modal spheres if they exist
        if (window.modalEventSphere && window.modalEventSphere.parent) {
          const modalPulse = Math.sin(performance.now() * 0.005) * 0.2 + 1;
          window.modalEventSphere.scale.setScalar(modalPulse);
          
          if (window.modalGlowSphere && window.modalGlowSphere.parent) {
            window.modalGlowSphere.scale.setScalar(modalPulse * 1.2);
            window.modalGlowSphere.rotation.y += 0.01;
          }
        }
      });
      
      /* Height adjustment - will be applied when devices arrive */
      const bounds = pc.boundingBox.clone().applyMatrix4(pc.matrixWorld);
      const rc = new THREE.Raycaster();
      rc.params.Points.threshold = 4;
      const heightOffsets = {};
      
      // Make heightOffsets globally available
      window.heightOffsets = heightOffsets;
      
      // Function to calculate height offset for a device
      window.calculateHeightOffset = (deviceId) => {
        if (!devicePaths[deviceId] || devicePaths[deviceId].length === 0) return;
        
        const firstPos = devicePaths[deviceId][0];
        rc.set(new THREE.Vector3(firstPos.x, firstPos.y, bounds.max.z + 5), new THREE.Vector3(0, 0, -1));
        const hit = rc.intersectObject(pc, true)[0];
        heightOffsets[deviceId] = hit ? hit.point.z - firstPos.z : 0;
        
        // Apply height offset to all positions for this device
        devicePaths[deviceId].forEach(p => p.z += heightOffsets[deviceId]);
        
        // Update 3D marker position if it exists
        if (markers3D[deviceId]) {
          const currentIndex = deviceCurrentIndex[deviceId] || 0;
          const pos = devicePaths[deviceId][currentIndex];
          markers3D[deviceId].geometry.attributes.position.set([pos.x, pos.y, pos.z]);
          markers3D[deviceId].geometry.attributes.position.needsUpdate = true;
          markers3D[deviceId].geometry.computeBoundingSphere();
        }
      };
      
      /* Tooltip */
      const tooltip = document.createElement('div');
      tooltip.className = 'fixed px-4 py-3 text-xs font-mono rounded-lg ' +
                         'opacity-0 pointer-events-none z-50 tooltip-glow transition-all duration-200';
      tooltip.style.maxWidth = '200px';
      document.body.appendChild(tooltip);
      
      /* Details panel */
      const detailsEl = document.getElementById('device_details');
      const detailsCard = document.getElementById('details_card');
      const showTrackingBtn = () => trackingBtn.classList.remove('hidden');
      
      /* Mouse interactions */
      const mouse = new THREE.Vector2();
      const dom = viewer.renderer.domElement;
      const uiRay = new THREE.Raycaster();
      
      dom.addEventListener('mousemove', e => {
        const r = dom.getBoundingClientRect();
        mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
        mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
        uiRay.setFromCamera(mouse, viewer.scene.getActiveCamera());
        
        let hoveredDevice = null;
        Object.values(markers3D).forEach(marker => {
          if (marker.visible) {
            const hit = uiRay.intersectObject(marker, true)[0];
            if (hit) {
              hoveredDevice = marker.userData.deviceId;
              const currentIndex = deviceCurrentIndex[hoveredDevice] || 0;
              const coord = devicePaths[hoveredDevice][currentIndex];
              if (coord) {
                const color = window.deviceColorMap[hoveredDevice];
                
                tooltip.innerHTML = `
                  <div class="font-bold mb-1" style="color: ${color.light}">Dispositivo ${hoveredDevice.slice(-4)}</div>
                  <div class="space-y-1">
                    <div><span class="text-text-muted">Lat:</span> ${coord.latitude.toFixed(6)}</div>
                    <div><span class="text-text-muted">Lon:</span> ${coord.longitude.toFixed(6)}</div>
                    <div><span class="text-text-muted">Alt:</span> ${coord.altitude.toFixed(2)} m</div>
                  </div>`;
                tooltip.style.left = `${e.clientX + 15}px`;
                tooltip.style.top = `${e.clientY + 15}px`;
                tooltip.classList.add('opacity-100');
                dom.style.cursor = 'pointer';
              }
            }
          }
        });
        
        if (!hoveredDevice) {
          tooltip.classList.remove('opacity-100');
          dom.style.cursor = 'default';
        }
      });
      
      /* Click handler */
      dom.addEventListener('click', e => {
        const r = dom.getBoundingClientRect();
        mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
        mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
        uiRay.setFromCamera(mouse, viewer.scene.getActiveCamera());
        
        Object.values(markers3D).forEach(marker => {
          if (marker.visible) {
            const hit = uiRay.intersectObject(marker, true)[0];
            if (hit) {
              const deviceId = marker.userData.deviceId;
              const currentIndex = deviceCurrentIndex[deviceId] || 0;
              const coord = devicePaths[deviceId][currentIndex];
              
              if (coord) {
                renderDetails(deviceId, coord);
                detailsEl.dataset.activeDevice = deviceId;
                window.trackedDeviceId = deviceId;
                showTrackingBtn();
                
                // Highlight effect
                detailsCard.style.borderColor = 'rgba(139, 92, 246, 0.5)';
                detailsCard.style.boxShadow = '0 0 30px rgba(139, 92, 246, 0.3)';
                setTimeout(() => {
                  detailsCard.style.borderColor = '';
                  detailsCard.style.boxShadow = '';
                }, 600);
              }
            }
          }
        });
      });
    });
    
    /* Initialize Application */
    // Ensure search input is empty initially
    document.getElementById('deviceSearch').value = '';
    
    // Start data source initialization
    initializeDataSource();
  </script>
</body>
</html>