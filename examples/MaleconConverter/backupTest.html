<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Krado</title>
  
  <!-- CSS externos -->
  <link rel="stylesheet" href="./libs/potree/potree.css">
  <link rel="stylesheet" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" href="./libs/jstree/themes/mixed/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Deep purple theme colors
            primary: '#8B5CF6',
            'primary-light': '#A78BFA',
            'primary-dark': '#7C3AED',
            'primary-glow': '#A78BFA',
            
            // Ultra dark backgrounds
            'bg-darkest': '#0A0A0F',
            'bg-dark': '#12121A',
            'bg-card': '#1A1A25',
            'bg-elevated': '#22223D',
            
            // Border and text colors
            'border-subtle': '#2A2A40',
            'text-muted': '#6B6B80',
            'text-secondary': '#9090A0'
          },
          animation: {
            'glow-pulse': 'glow-pulse 2s ease-in-out infinite',
            'fade-in': 'fade-in 0.5s ease-out',
            'slide-in': 'slide-in 0.3s ease-out'
          },
          boxShadow: {
            'glow': '0 0 20px rgba(139, 92, 246, 0.15)',
            'glow-lg': '0 0 40px rgba(139, 92, 246, 0.2)',
            'inner-glow': 'inset 0 0 20px rgba(139, 92, 246, 0.1)',
            'card': '0 2px 8px rgba(0, 0, 0, 0.4), 0 0 1px rgba(139, 92, 246, 0.2)'
          }
        }
      }
    };
  </script>
  
  <style>
    /* Base styles */
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #0A0A0F;
      color: #E0E0EF;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    
    /* Glow animations */
    @keyframes glow-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }
    
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slide-in {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    /* Sidebar icon styles */
    .sidebar-icon {
      position: relative;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 0.5rem;
    }
    
    .sidebar-icon:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    
    .sidebar-icon.active {
      background: rgba(139, 92, 246, 0.15);
    }
    
    .sidebar-icon.active::before {
      content: '';
      position: absolute;
      left: -12px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 20px;
      background: linear-gradient(to bottom, transparent, #8B5CF6, transparent);
      border-radius: 2px;
    }
    
    .sidebar-icon svg {
      width: 20px;
      height: 20px;
      color: #6B6B80;
      transition: color 0.3s ease;
    }
    
    .sidebar-icon:hover svg,
    .sidebar-icon.active svg {
      color: #A78BFA;
      filter: drop-shadow(0 0 8px rgba(167, 139, 250, 0.5));
    }
    
    /* Card styles */
    .glass-card {
      background: linear-gradient(135deg, #1A1A25 0%, #12121A 100%);
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .glass-card:hover {
      border-color: rgba(139, 92, 246, 0.2);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 30px rgba(139, 92, 246, 0.1);
    }
    
    /* Button styles */
    .btn-primary {
      background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%);
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .btn-secondary {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.3);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
    }
    
    /* Input styles */
    .input-dark {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(139, 92, 246, 0.1);
      transition: all 0.3s ease;
    }
    
    .input-dark:focus {
      outline: none;
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    /* Search bar styles */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .search-input {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 0.5rem 0 0 0.5rem;
      padding: 0.5rem 1rem;
      color: #E0E0EF;
      font-size: 0.875rem;
      width: 200px;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .search-input::placeholder {
      color: #6B6B80;
    }
    
    .search-btn {
      background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-left: none;
      border-radius: 0 0.5rem 0.5rem 0;
      padding: 0.5rem 0.75rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-btn:hover {
      background: linear-gradient(135deg, #6D28D9 0%, #7C3AED 100%);
      box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
    }
    
    .search-btn svg {
      width: 16px;
      height: 16px;
    }
    
    /* Stat card styles */
    .stat-value {
      background: linear-gradient(135deg, #A78BFA 0%, #8B5CF6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.3));
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.5);
    }
    
    /* Tooltip styles */
    .tooltip-glow {
      background: rgba(26, 26, 37, 0.95);
      border: 1px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(139, 92, 246, 0.2);
      backdrop-filter: blur(10px);
    }
    
    /* Device legend */
    .device-legend {
      background: rgba(26, 26, 37, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.1);
    }
    
    .device-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      filter: drop-shadow(0 0 4px currentColor);
    }
    
    /* Device list item styles */
    .device-item {
      background: rgba(139, 92, 246, 0.05);
      border: 1px solid rgba(139, 92, 246, 0.1);
      border-radius: 0.5rem;
      padding: 0.75rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .device-item:hover {
      background: rgba(139, 92, 246, 0.1);
      border-color: rgba(139, 92, 246, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .device-item.active {
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.3);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
    }
    
    .device-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10B981;
      animation: pulse 2s infinite;
    }
    
    .device-status.offline {
      background: #6B7280;
      animation: none;
    }
  </style>
</head>

<body class="h-screen w-screen overflow-hidden">
  <!-- Main Layout -->
  <div class="flex h-full bg-bg-darkest">
    
    <!-- Icon Sidebar (Left) -->
    <aside class="w-16 bg-bg-dark border-r border-border-subtle flex flex-col items-center py-4">
      <!-- Logo -->
      <div class="mb-8">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center shadow-glow">
          <span class="text-white font-bold text-lg">K</span>
        </div>
      </div>
      
      <!-- Navigation Icons -->
      <nav class="flex-1 flex flex-col gap-4">
        <div class="sidebar-icon active" data-view="3d" title="Vista 3D">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"/>
          </svg>
        </div>
        
        <div class="sidebar-icon" data-view="2d" title="Mapa 2D">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
          </svg>
        </div>
        
        <div class="sidebar-icon" title="Análisis">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        
        <div class="sidebar-icon" title="Alertas">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
        </div>
      </nav>
      
      <!-- Settings -->
      <div class="sidebar-icon mt-auto" title="Configuración">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 bg-bg-darkest p-6 overflow-hidden">
      <div class="h-full flex flex-col gap-6">
        
        <!-- Header -->
        <header class="flex items-center justify-between animate-fade-in">
          <div>
            <h1 class="text-3xl font-bold">
              <span class="stat-value ml-2">Krado</span>
              <span class="text-white">Dashboard</span>
            </h1>
            <p class="text-text-muted text-sm mt-1">Sistema de monitoreo en tiempo real</p>
          </div>
          
          <!-- Search Bar -->
          <div class="search-container">
            <input type="text" 
                   id="deviceSearch"
                   placeholder="Buscar dispositivo..."
                   class="search-input"
                   pattern="[0-9]*"
                   inputmode="numeric">
            <button id="searchBtn" class="search-btn" title="Buscar">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </button>
          </div>
          
          <div class="flex items-center gap-4">
            <!-- Status indicator -->
            <div class="flex items-center gap-2 px-4 py-2 rounded-lg glass-card">
              <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
              <span class="text-sm text-text-secondary">Conectado</span>
            </div>
            
            <!-- User profile -->
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary-dark shadow-glow"></div>
          </div>
        </header>
        
        <!-- Main Grid -->
        <div class="flex-1 overflow-hidden">
          
          <!-- 3D View -->
          <div id="view3D" class="h-full grid grid-cols-12 gap-6">
            
            <!-- 3D Viewer (Main) -->
            <div class="col-span-8 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in">
              <div class="h-full relative">
                <div class="potree_container absolute inset-0">
                  <div id="potree_render_area" class="w-full h-full rounded-2xl" 
                       style="background: radial-gradient(ellipse at center, #1A1A25 0%, #0A0A0F 100%)"></div>
                  <div id="potree_sidebar_container"></div>
                </div>
                
                <!-- Overlay controls -->
                <div class="absolute top-4 left-4 flex gap-2">
                  <button class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Zoom
                  </button>
                  <button class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Resetear
                  </button>
                </div>
                
                <!-- Device Legend -->
                <div id="deviceLegend" class="absolute bottom-4 left-4 device-legend rounded-lg px-4 py-3 text-xs">
                  <div class="font-semibold text-white mb-2">Dispositivos activos</div>
                  <div id="legendContent" class="space-y-1"></div>
                </div>
              </div>
            </div>
            
            <!-- Right Panel -->
            <div class="col-span-4 flex flex-col gap-6 overflow-hidden">
              
              <!-- Map Card -->
              <div class="flex-1 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in" style="animation-delay: 0.1s">
                <div class="h-full relative">
                  <div id="map_container" class="w-full h-full rounded-2xl"></div>
                  
                  <!-- Map overlay -->
                  <div class="absolute top-4 left-4 right-4">
                    <div class="bg-bg-dark/80 backdrop-blur-sm rounded-lg px-3 py-2 border border-border-subtle">
                      <p class="text-xs text-text-muted">Ubicación actual</p>
                      <p class="text-sm font-medium text-primary-light">Lat: --, Lng: --</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Stats Grid -->
              <div class="grid grid-cols-2 gap-4">
                <!-- Stat Card 1 -->
                <div class="glass-card rounded-xl p-4 shadow-card animate-fade-in" style="animation-delay: 0.2s">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs uppercase tracking-wider">Velocidad</span>
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                  </div>
                  <p class="text-2xl font-bold stat-value">0.0</p>
                  <p class="text-xs text-text-secondary">km/h</p>
                </div>
                
                <!-- Stat Card 2 -->
                <div class="glass-card rounded-xl p-4 shadow-card animate-fade-in" style="animation-delay: 0.3s">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs uppercase tracking-wider">Altitud</span>
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                    </svg>
                  </div>
                  <p class="text-2xl font-bold stat-value">--</p>
                  <p class="text-xs text-text-secondary">metros</p>
                </div>
              </div>
              
              <!-- Device Details -->
              <div id="details_card" class="glass-card rounded-2xl p-6 shadow-card animate-fade-in" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-white">Detalles del dispositivo</h3>
                  <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                </div>
                
                <div id="device_details" class="space-y-3 text-sm">
                  <div class="flex items-center justify-between py-2 border-b border-border-subtle">
                    <span class="text-text-muted">Estado</span>
                    <span class="text-text-secondary">Sin conexión</span>
                  </div>
                  <p class="text-center text-text-muted py-8">
                    Haz clic en un marcador para ver información
                  </p>
                </div>
                
                <button id="trackingBtn" 
                        class="mt-4 w-full py-2.5 btn-primary rounded-lg text-sm font-medium hidden">
                  Iniciar seguimiento
                </button>
              </div>
              
            </div>
          </div>
          
          <!-- 2D Map View -->
          <div id="view2D" class="h-full grid grid-cols-12 gap-6 hidden">
            
            <!-- Large Map -->
            <div class="col-span-8 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in">
              <div class="h-full relative">
                <div id="fullmap_container" class="w-full h-full rounded-2xl"></div>
                
                <!-- Map Controls -->
                <div class="absolute top-4 left-4 flex gap-2">
                  <button id="centerMapBtn" class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Centrar
                  </button>
                  <button id="fitBoundsBtn" class="px-3 py-1.5 text-xs btn-secondary rounded-lg backdrop-blur-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                    </svg>
                    Ajustar vista
                  </button>
                </div>
                
                <!-- Map Info -->
                <div class="absolute top-4 right-4">
                  <div class="bg-bg-dark/80 backdrop-blur-sm rounded-lg px-3 py-2 border border-border-subtle">
                    <p class="text-xs text-text-muted">Dispositivos visibles</p>
                    <p id="visibleDevicesCount" class="text-sm font-medium text-primary-light">--</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Device List Panel -->
            <div class="col-span-4 flex flex-col gap-6 overflow-hidden">
              
              <!-- Device List -->
              <div class="flex-1 glass-card rounded-2xl overflow-hidden shadow-card animate-fade-in" style="animation-delay: 0.1s">
                <div class="h-full flex flex-col">
                  <div class="p-4 border-b border-border-subtle">
                    <h3 class="text-lg font-semibold text-white">Lista de dispositivos</h3>
                    <p class="text-text-muted text-sm mt-1">Dispositivos detectados en tiempo real</p>
                  </div>
                  
                  <div class="flex-1 overflow-y-auto p-4">
                    <div id="deviceList" class="space-y-3"></div>
                  </div>
                </div>
              </div>
              
              <!-- Map Statistics -->
              <div class="grid grid-cols-1 gap-4">
                <!-- Active Devices Stat -->
                <div class="glass-card rounded-xl p-4 shadow-card animate-fade-in" style="animation-delay: 0.2s">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-text-muted text-xs uppercase tracking-wider">Dispositivos activos</span>
                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                    </svg>
                  </div>
                  <p id="activeDevicesCount" class="text-2xl font-bold stat-value">0</p>
                  <p class="text-xs text-text-secondary">en línea</p>
                </div>
              </div>
              
            </div>
          </div>
          
        </div>
        
      </div>
    </main>
  </div>
  
  <!-- Scripts externos -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r124/three.min.js"></script>
  <script src="./libs/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>
  
  <!-- Main Script -->
  <script type="module">
    import { getTestCoords, getTestCoords2 } from './dataTesting.js';
    
    /* View Management */
    let currentView = '3d';
    let fullMap = null;
    let fullMapMarkers = {};
    
    const switchView = (view) => {
      const view3D = document.getElementById('view3D');
      const view2D = document.getElementById('view2D');
      const sidebarIcons = document.querySelectorAll('.sidebar-icon[data-view]');
      
      // Remove active class from all view icons
      sidebarIcons.forEach(icon => icon.classList.remove('active'));
      
      if (view === '3d') {
        view3D.classList.remove('hidden');
        view2D.classList.add('hidden');
        document.querySelector('[data-view="3d"]').classList.add('active');
        currentView = '3d';
        
        // Invalidate small map size after view switch
        setTimeout(() => {
          if (window.map) {
            window.map.invalidateSize();
          }
        }, 300);
      } else if (view === '2d') {
        view3D.classList.add('hidden');
        view2D.classList.remove('hidden');
        document.querySelector('[data-view="2d"]').classList.add('active');
        currentView = '2d';
        
        // Initialize or refresh full map
        setTimeout(() => {
          initializeFullMap();
        }, 300);
      }
    };
    
    // Add click handlers to sidebar icons
    document.querySelectorAll('.sidebar-icon[data-view]').forEach(icon => {
      icon.addEventListener('click', () => {
        const view = icon.getAttribute('data-view');
        switchView(view);
      });
    });
    
    /* Projection setup */
    proj4.defs('EPSG:32618', '+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs');
    const wgs84 = 'EPSG:4326', utm18 = 'EPSG:32618';
    
    /* GPS Data and Device Grouping */
    const gpsCoords = getTestCoords2();
    
    // Group coordinates by device ID
    const deviceGroups = {};
    const deviceColors = [
      { base: '#8B5CF6', light: '#A78BFA' },    // Primary purple
      { base: '#6366F1', light: '#818CF8' },    // Indigo
      { base: '#9333EA', light: '#A855F7' },    // Violet
      { base: '#7C3AED', light: '#A78BFA' },    // Dark purple
      { base: '#4F46E5', light: '#6366F1' },    // Dark indigo
      { base: '#7E22CE', light: '#9333EA' },    // Dark violet
      { base: '#A855F7', light: '#C084FC' },    // Light violet
      { base: '#818CF8', light: '#A5B4FC' }     // Light indigo
    ];
    
    // Group data by device
    gpsCoords.forEach(coord => {
      if (!deviceGroups[coord.deviceId]) {
        deviceGroups[coord.deviceId] = [];
      }
      deviceGroups[coord.deviceId].push(coord);
    });
    
    const deviceIds = Object.keys(deviceGroups);
    const deviceColorMap = {};
    deviceIds.forEach((id, idx) => {
      deviceColorMap[id] = deviceColors[idx % deviceColors.length];
    });
    
    // Convert coordinates for each device
    const devicePaths = {};
    Object.entries(deviceGroups).forEach(([deviceId, coords]) => {
      devicePaths[deviceId] = coords.map(p => {
        const [x, y] = proj4(wgs84, utm18, [p.longitude, p.latitude]);
        return { x, y, z: p.altitude, ...p };
      });
    });
    
    /* Device List Management */
    const updateDeviceList = () => {
      const deviceList = document.getElementById('deviceList');
      const activeDevicesCount = document.getElementById('activeDevicesCount');
      const visibleDevicesCount = document.getElementById('visibleDevicesCount');
      
      if (!deviceList) return;
      
      deviceList.innerHTML = '';
      
      filteredDeviceIds.forEach(deviceId => {
        const color = deviceColorMap[deviceId];
        const currentCoord = devicePaths[deviceId][deviceIndexes[deviceId] || 0];
        
        const deviceItem = document.createElement('div');
        deviceItem.className = 'device-item';
        deviceItem.dataset.deviceId = deviceId;
        
        deviceItem.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="device-status"></div>
              <span class="font-medium text-white">Dispositivo ${deviceId.slice(-4)}</span>
            </div>
            <div class="device-indicator" style="background: ${color.base}; width: 10px; height: 10px;"></div>
          </div>
          <div class="text-xs text-text-muted space-y-1">
            <div>ID: <span class="text-text-secondary font-mono">${deviceId}</span></div>
            <div>Lat: <span class="text-primary-light">${currentCoord.latitude.toFixed(6)}</span></div>
            <div>Lng: <span class="text-primary-light">${currentCoord.longitude.toFixed(6)}</span></div>
            ${currentCoord.custom && currentCoord.custom.heartRate ? 
              `<div>HR: <span class="text-green-400">${currentCoord.custom.heartRate} bpm</span></div>` : ''}
          </div>
        `;
        
        deviceItem.addEventListener('click', () => {
          // Remove active class from all items
          document.querySelectorAll('.device-item').forEach(item => 
            item.classList.remove('active'));
          deviceItem.classList.add('active');
          
          // Center map on selected device if in 2D view
          if (currentView === '2d' && fullMap) {
            fullMap.setView([currentCoord.latitude, currentCoord.longitude], 18, {
              animate: true,
              duration: 1
            });
          }
          
          // Update device details in 3D view
          if (currentView === '3d') {
            const detailsEl = document.getElementById('device_details');
            const trackingBtn = document.getElementById('trackingBtn');
            
            detailsEl.dataset.activeDevice = deviceId;
            window.trackedDeviceId = deviceId;
            trackingBtn.classList.remove('hidden');
            
            // Update details
            renderDetails(deviceId, currentCoord);
          }
        });
        
        deviceList.appendChild(deviceItem);
      });
      
      // Update counters
      if (activeDevicesCount) {
        activeDevicesCount.textContent = filteredDeviceIds.length;
      }
      if (visibleDevicesCount) {
        visibleDevicesCount.textContent = filteredDeviceIds.length;
      }
    };
    
    /* Full Map Initialization */
    const initializeFullMap = () => {
      if (fullMap) {
        fullMap.invalidateSize();
        return;
      }
      
      fullMap = L.map('fullmap_container', {
        zoomControl: true,
        attributionControl: false,
        scrollWheelZoom: true, // Enable zoom
        doubleClickZoom: true,
        touchZoom: true,
        boxZoom: true,
        keyboard: true
      }).setView([gpsCoords[0].latitude, gpsCoords[0].longitude], 16);
      
      // Dark map style
      L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
        maxZoom: 20,
        attribution: ''
      }).addTo(fullMap);
      
      // Create markers for full map
      Object.entries(deviceGroups).forEach(([deviceId, coords]) => {
        const color = deviceColorMap[deviceId];
        const marker = L.circleMarker([coords[0].latitude, coords[0].longitude], {
          radius: 10,
          color: color.light,
          fillColor: color.base,
          fillOpacity: 0.8,
          weight: 3
        });
        
        // Add popup
        marker.bindPopup(`
          <div class="text-sm">
            <div class="font-bold mb-1" style="color: ${color.light}">
              Dispositivo ${deviceId.slice(-4)}
            </div>
            <div class="space-y-1 text-xs">
              <div>ID: ${deviceId}</div>
              <div>Lat: ${coords[0].latitude.toFixed(6)}</div>
              <div>Lng: ${coords[0].longitude.toFixed(6)}</div>
              <div>Alt: ${coords[0].altitude.toFixed(2)} m</div>
            </div>
          </div>
        `, {
          className: 'tooltip-glow'
        });
        
        fullMapMarkers[deviceId] = marker;
        
        if (filteredDeviceIds.includes(deviceId)) {
          marker.addTo(fullMap);
        }
      });
      
      // Add map control handlers
      document.getElementById('centerMapBtn')?.addEventListener('click', () => {
        if (filteredDeviceIds.length > 0) {
          const firstDevice = filteredDeviceIds[0];
          const coord = devicePaths[firstDevice][deviceIndexes[firstDevice] || 0];
          fullMap.setView([coord.latitude, coord.longitude], 16, { animate: true });
        }
      });
      
      document.getElementById('fitBoundsBtn')?.addEventListener('click', () => {
        if (filteredDeviceIds.length > 0) {
          const bounds = L.latLngBounds();
          filteredDeviceIds.forEach(deviceId => {
            const coord = devicePaths[deviceId][deviceIndexes[deviceId] || 0];
            bounds.extend([coord.latitude, coord.longitude]);
          });
          fullMap.fitBounds(bounds, { padding: [20, 20], animate: true });
        }
      });
      
      // Update device list
      updateDeviceList();
    };
    
    /* Search functionality */
    let filteredDeviceIds = [...deviceIds]; // Initially show all devices
    
    const deviceSearchInput = document.getElementById('deviceSearch');
    const searchBtn = document.getElementById('searchBtn');
    
    // Only allow numbers in search input
    deviceSearchInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    const performSearch = () => {
      const searchValue = deviceSearchInput.value.trim();
      
      if (searchValue === '') {
        // If search is empty, show all devices
        filteredDeviceIds = [...deviceIds];
      } else {
        // Filter devices that contain the search sequence
        filteredDeviceIds = deviceIds.filter(deviceId => 
          deviceId.includes(searchValue)
        );
      }
      
      updateDeviceVisibility();
    };
    
    // Search on button click
    searchBtn.addEventListener('click', performSearch);
    
    // Search on Enter key press
    deviceSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
    
    const updateDeviceVisibility = () => {
      // Update 3D markers visibility
      if (window.markers3D) {
        Object.entries(window.markers3D).forEach(([deviceId, marker]) => {
          marker.visible = filteredDeviceIds.includes(deviceId);
        });
      }
      
      // Update 2D markers visibility (small map)
      if (window.markers2D) {
        Object.entries(window.markers2D).forEach(([deviceId, marker]) => {
          if (filteredDeviceIds.includes(deviceId)) {
            marker.addTo(map);
          } else {
            marker.remove();
          }
        });
      }
      
      // Update full map markers visibility
      if (fullMapMarkers) {
        Object.entries(fullMapMarkers).forEach(([deviceId, marker]) => {
          if (filteredDeviceIds.includes(deviceId)) {
            if (fullMap) marker.addTo(fullMap);
          } else {
            marker.remove();
          }
        });
      }
      
      // Update legend
      updateLegend();
      
      // Update device list
      updateDeviceList();
      
      // If currently tracked device is filtered out, stop tracking
      if (window.trackedDeviceId && !filteredDeviceIds.includes(window.trackedDeviceId)) {
        window.trackingEnabled = false;
        window.trackedDeviceId = null;
        window.cameraOffset = null;
        const trackingBtn = document.getElementById('trackingBtn');
        trackingBtn.textContent = 'Iniciar seguimiento';
        trackingBtn.classList.remove('btn-secondary');
        trackingBtn.classList.add('btn-primary');
        trackingBtn.classList.add('hidden');
        
        // Clear device details if filtered device was active
        const detailsEl = document.getElementById('device_details');
        if (detailsEl.dataset.activeDevice && !filteredDeviceIds.includes(detailsEl.dataset.activeDevice)) {
          delete detailsEl.dataset.activeDevice;
          detailsEl.innerHTML = `
            <div class="flex items-center justify-between py-2 border-b border-border-subtle">
              <span class="text-text-muted">Estado</span>
              <span class="text-text-secondary">Sin conexión</span>
            </div>
            <p class="text-center text-text-muted py-8">
              Haz clic en un marcador para ver información
            </p>`;
        }
      }
    };
    
    const updateLegend = () => {
      const legendContent = document.getElementById('legendContent');
      legendContent.innerHTML = '';
      
      filteredDeviceIds.forEach(deviceId => {
        const color = deviceColorMap[deviceId];
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
          <span class="device-indicator" style="background: ${color.base};"></span>
          <span class="text-text-secondary">Dispositivo ${deviceId.slice(-4)}</span>
        `;
        legendContent.appendChild(div);
      });
    };
    
    /* Leaflet Map Setup (Small map in 3D view) */
    const map = L.map('map_container', {
      zoomControl: false,
      attributionControl: false,
      scrollWheelZoom: false
    }).setView([gpsCoords[0].latitude, gpsCoords[0].longitude], 16);
    
    // Dark map style
    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      attribution: ''
    }).addTo(map);
    
    // Create 2D markers for each device
    const markers2D = {};
    Object.entries(deviceGroups).forEach(([deviceId, coords]) => {
      const color = deviceColorMap[deviceId];
      markers2D[deviceId] = L.circleMarker([coords[0].latitude, coords[0].longitude], {
        radius: 8,
        color: color.light,
        fillColor: color.base,
        fillOpacity: 0.8,
        weight: 2
      }).addTo(map);
    });
    
    // Make markers2D available globally for search functionality
    window.markers2D = markers2D;
    window.map = map;
    
    setTimeout(() => map.invalidateSize(), 400);
    
    /* Device Legend */
    updateLegend();
    
    /* Tracking state */
    let trackingEnabled = false;
    let cameraOffset = null;
    let trackedDeviceId = null;
    const deviceIndexes = {};
    deviceIds.forEach(id => deviceIndexes[id] = 0);
    
    // Make tracking variables global for search functionality
    window.trackingEnabled = trackingEnabled;
    window.trackedDeviceId = trackedDeviceId;
    window.cameraOffset = cameraOffset;
    
    const trackingBtn = document.getElementById('trackingBtn');
    trackingBtn.onclick = () => {
      window.trackingEnabled = !window.trackingEnabled;
      trackingBtn.textContent = window.trackingEnabled ? 'Detener seguimiento' : 'Iniciar seguimiento';
      trackingBtn.classList.toggle('btn-primary');
      trackingBtn.classList.toggle('btn-secondary');
      
      if (window.trackingEnabled && window.trackedDeviceId) {
        const camPos = viewer.scene.view.position.clone();
        const currentCoord = devicePaths[window.trackedDeviceId][deviceIndexes[window.trackedDeviceId]];
        const markerPos = new THREE.Vector3(currentCoord.x, currentCoord.y, currentCoord.z);
        window.cameraOffset = camPos.sub(markerPos);
      } else {
        window.cameraOffset = null;
      }
    };
    
    /* Details panel helper */
    const renderDetails = (deviceId, coord) => {
      const detailsEl = document.getElementById('device_details');
      const color = deviceColorMap[deviceId];
      detailsEl.innerHTML = `
        <div class="space-y-3">
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Dispositivo</span>
            <span class="font-mono" style="color: ${color.base}">${deviceId.slice(-4)}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Latitud</span>
            <span class="font-mono text-primary-light">${coord.latitude.toFixed(6)}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Longitud</span>
            <span class="font-mono text-primary-light">${coord.longitude.toFixed(6)}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Altitud</span>
            <span class="font-mono text-primary-light">${coord.altitude.toFixed(2)} m</span>
          </div>
          ${coord.custom && coord.custom.heartRate ? `
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Frecuencia cardíaca</span>
            <span class="font-mono text-primary-light">${coord.custom.heartRate} bpm</span>
          </div>` : ''}
          ${coord.custom && coord.custom.steps !== undefined ? `
          <div class="flex items-center justify-between py-2 border-b border-border-subtle">
            <span class="text-text-muted">Pasos</span>
            <span class="font-mono text-primary-light">${coord.custom.steps}</span>
          </div>` : ''}
          <div class="flex items-center justify-between py-2">
            <span class="text-text-muted">Tiempo</span>
            <span class="text-text-secondary">${new Date().toLocaleTimeString()}</span>
          </div>
        </div>`;
        
      // Update map overlay
      document.querySelector('.bg-bg-dark\\/80 p').nextElementSibling.textContent = 
        `Lat: ${coord.latitude.toFixed(6)}, Lng: ${coord.longitude.toFixed(6)}`;
        
      // Update stats
      document.querySelector('.stat-value').textContent = (Math.random() * 5 + 2).toFixed(1);
      document.querySelectorAll('.stat-value')[1].textContent = coord.altitude.toFixed(1);
    };
    
    /* Potree Viewer */
    window.viewer = new Potree.Viewer(document.getElementById('potree_render_area'));
    viewer.useHQ = true;
    viewer.setEDLEnabled(true);
    viewer.setFOV(60);
    viewer.setPointBudget(500000);
    viewer.loadGUI(() => {
      viewer.setLanguage('es');
      $('#menu_appearance').next().show();
    });
    viewer.loadSettingsFromURL();
    
    // Load point cloud
    Potree.loadPointCloud('./pointclouds/malecon/metadata.json', 'malecon', e => {
      const pc = e.pointcloud;
      Object.assign(pc.material, {
        size: 1,
        pointSizeType: Potree.PointSizeType.ADAPTIVE,
        shape: Potree.PointShape.CIRCLE,
        activeAttributeName: 'elevation',
        gradient: Potree.Gradients.VIRIDIS,
        needsUpdate: true
      });
      viewer.scene.addPointCloud(pc);
      viewer.fitToScreen();
      
      /* Create 3D Markers for each device */
      const markers3D = {};
      const markerGroup = new THREE.Group();
      
      const makeTexture = (color) => {
        const s = 256, c = document.createElement('canvas');
        c.width = c.height = s;
        const ctx = c.getContext('2d');
        
        // Parse hex color
        const r = parseInt(color.base.slice(1,3), 16);
        const g = parseInt(color.base.slice(3,5), 16);
        const b = parseInt(color.base.slice(5,7), 16);
        
        // Outer glow
        const g1 = ctx.createRadialGradient(s/2, s/2, 0, s/2, s/2, s/2);
        g1.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.3)`);
        g1.addColorStop(0.5, `rgba(${r}, ${g}, ${b}, 0.1)`);
        g1.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);
        ctx.fillStyle = g1;
        ctx.fillRect(0, 0, s, s);
        
        // Inner circle
        const g2 = ctx.createRadialGradient(s/2, s/2, s*0.15, s/2, s/2, s*0.25);
        g2.addColorStop(0, color.light);
        g2.addColorStop(1, color.base);
        ctx.fillStyle = g2;
        ctx.beginPath();
        ctx.arc(s/2, s/2, s*0.2, 0, Math.PI * 2);
        ctx.fill();
        
        return new THREE.CanvasTexture(c);
      };
      
      // Create a marker for each device
      deviceIds.forEach(deviceId => {
        const geom = new THREE.BufferGeometry().setAttribute('position', 
          new THREE.BufferAttribute(new Float32Array(3), 3));
        geom.computeBoundingSphere();
        
        const mat = new THREE.PointsMaterial({
          map: makeTexture(deviceColorMap[deviceId]),
          size: 32,
          sizeAttenuation: false,
          transparent: true,
          opacity: 0,
          depthTest: false,
          depthWrite: false
        });
        
        const marker = new THREE.Points(geom, mat);
        marker.frustumCulled = false;
        marker.renderOrder = 9999;
        marker.userData.deviceId = deviceId;
        
        markers3D[deviceId] = marker;
        markerGroup.add(marker);
      });
      
      // Make markers3D available globally for search functionality
      window.markers3D = markers3D;
      
      viewer.scene.scene.add(markerGroup);
      
      // Pulsing animation for all markers
      viewer.addEventListener('update', () => {
        const pulse = Math.sin(performance.now() * 0.003) * 0.2 + 0.8;
        Object.values(markers3D).forEach(marker => {
          if (marker.visible) {
            marker.material.opacity = pulse;
            marker.material.size = 32 + Math.sin(performance.now() * 0.006) * 8;
          }
        });
      });
      
      /* Height adjustment for all devices */
      const bounds = pc.boundingBox.clone().applyMatrix4(pc.matrixWorld);
      const rc = new THREE.Raycaster();
      rc.params.Points.threshold = 4;
      const heightOffsets = {};
      
      setTimeout(() => {
        // Calculate height offset for each device's first position
        Object.entries(devicePaths).forEach(([deviceId, path]) => {
          const firstPos = path[0];
          rc.set(new THREE.Vector3(firstPos.x, firstPos.y, bounds.max.z + 5), new THREE.Vector3(0, 0, -1));
          const hit = rc.intersectObject(pc, true)[0];
          heightOffsets[deviceId] = hit ? hit.point.z - firstPos.z : 0;
          
          // Apply height offset to all positions
          path.forEach(p => p.z += heightOffsets[deviceId]);
        });
        
        // Initialize marker positions
        Object.entries(markers3D).forEach(([deviceId, marker]) => {
          const pos = devicePaths[deviceId][0];
          marker.material.opacity = 1;
          marker.geometry.attributes.position.set([pos.x, pos.y, pos.z]);
          marker.geometry.attributes.position.needsUpdate = true;
          marker.geometry.computeBoundingSphere();
        });
        
        /* Tooltip */
        const tooltip = document.createElement('div');
        tooltip.className = 'fixed px-4 py-3 text-xs font-mono rounded-lg ' +
                           'opacity-0 pointer-events-none z-50 tooltip-glow transition-all duration-200';
        tooltip.style.maxWidth = '200px';
        document.body.appendChild(tooltip);
        
        /* Details panel */
        const detailsEl = document.getElementById('device_details');
        const detailsCard = document.getElementById('details_card');
        const showTrackingBtn = () => trackingBtn.classList.remove('hidden');
        
        /* Animation loop - move all devices */
        setInterval(() => {
          Object.entries(devicePaths).forEach(([deviceId, path]) => {
            deviceIndexes[deviceId] = (deviceIndexes[deviceId] + 1) % path.length;
            const currentPos = path[deviceIndexes[deviceId]];
            
            // Update 3D marker only if visible
            const marker3D = markers3D[deviceId];
            if (marker3D.visible) {
              marker3D.geometry.attributes.position.set([currentPos.x, currentPos.y, currentPos.z]);
              marker3D.geometry.attributes.position.needsUpdate = true;
              marker3D.geometry.computeBoundingSphere();
            }
            
            // Update 2D marker only if in filtered list (small map)
            if (filteredDeviceIds.includes(deviceId)) {
              markers2D[deviceId].setLatLng([currentPos.latitude, currentPos.longitude]);
              
              // Update full map marker if in 2D view
              if (fullMapMarkers[deviceId] && fullMap) {
                fullMapMarkers[deviceId].setLatLng([currentPos.latitude, currentPos.longitude]);
              }
            }
          });
          
          // Update device list in real-time
          if (currentView === '2d') {
            updateDeviceList();
          }
          
          // Handle tracking
          if (window.trackingEnabled && window.trackedDeviceId) {
            const trackedPos = devicePaths[window.trackedDeviceId][deviceIndexes[window.trackedDeviceId]];
            markers2D[window.trackedDeviceId].getLatLng();
            map.panTo([trackedPos.latitude, trackedPos.longitude], { animate: true, duration: 1 });
            
            if (window.cameraOffset) {
              const markerPos = new THREE.Vector3(trackedPos.x, trackedPos.y, trackedPos.z);  
              viewer.scene.view.position.copy(markerPos.clone().add(window.cameraOffset));
              viewer.scene.view.lookAt(markerPos);
              viewer.scene.view.updateCamera(viewer.scene.camera);
            }
          }
          
          // Update details if active
          if (detailsEl.dataset.activeDevice) {
            const activeDevice = detailsEl.dataset.activeDevice;
            const currentCoord = devicePaths[activeDevice][deviceIndexes[activeDevice]];
            renderDetails(activeDevice, currentCoord);
          }
        }, 5000);
        
        /* Mouse interactions */
        const mouse = new THREE.Vector2();
        const dom = viewer.renderer.domElement;
        const uiRay = new THREE.Raycaster();
        
        dom.addEventListener('mousemove', e => {
          const r = dom.getBoundingClientRect();
          mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
          mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
          uiRay.setFromCamera(mouse, viewer.scene.getActiveCamera());
          
          let hoveredDevice = null;
          Object.values(markers3D).forEach(marker => {
            if (marker.visible) {
              const hit = uiRay.intersectObject(marker, true)[0];
              if (hit) {
                hoveredDevice = marker.userData.deviceId;
                const coord = devicePaths[hoveredDevice][deviceIndexes[hoveredDevice]];
                const color = deviceColorMap[hoveredDevice];
                
                tooltip.innerHTML = `
                  <div class="font-bold mb-1" style="color: ${color.light}">Dispositivo ${hoveredDevice.slice(-4)}</div>
                  <div class="space-y-1">
                    <div><span class="text-text-muted">Lat:</span> ${coord.latitude.toFixed(6)}</div>
                    <div><span class="text-text-muted">Lon:</span> ${coord.longitude.toFixed(6)}</div>
                    <div><span class="text-text-muted">Alt:</span> ${coord.altitude.toFixed(2)} m</div>
                  </div>`;
                tooltip.style.left = `${e.clientX + 15}px`;
                tooltip.style.top = `${e.clientY + 15}px`;
                tooltip.classList.add('opacity-100');
                dom.style.cursor = 'pointer';
              }
            }
          });
          
          if (!hoveredDevice) {
            tooltip.classList.remove('opacity-100');
            dom.style.cursor = 'default';
          }
        });
        
        /* Click handler */
        dom.addEventListener('click', e => {
          const r = dom.getBoundingClientRect();
          mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
          mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
          uiRay.setFromCamera(mouse, viewer.scene.getActiveCamera());
          
          Object.values(markers3D).forEach(marker => {
            if (marker.visible) {
              const hit = uiRay.intersectObject(marker, true)[0];
              if (hit) {
                const deviceId = marker.userData.deviceId;
                const coord = devicePaths[deviceId][deviceIndexes[deviceId]];
                
                renderDetails(deviceId, coord);
                detailsEl.dataset.activeDevice = deviceId;
                window.trackedDeviceId = deviceId;
                showTrackingBtn();
                
                // Highlight effect
                detailsCard.style.borderColor = 'rgba(139, 92, 246, 0.5)';
                detailsCard.style.boxShadow = '0 0 30px rgba(139, 92, 246, 0.3)';
                setTimeout(() => {
                  detailsCard.style.borderColor = '';
                  detailsCard.style.boxShadow = '';
                }, 600);
              }
            }
          });
        });
        
      }, 2000);
    });
  </script>
</body>
</html>